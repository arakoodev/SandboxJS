"use strict";function asyncGeneratorStep(t,n,r,i,o,s,a){try{var c=t[s](a),p=c.value}catch(t){return void r(t)}c.done?n(p):Promise.resolve(p).then(i,o)}function _asyncToGenerator(t){return function(){var n=this,r=arguments;return new Promise((function(i,o){var s=t.apply(n,r);function a(t){asyncGeneratorStep(s,i,o,a,c,"next",t)}function c(t){asyncGeneratorStep(s,i,o,a,c,"throw",t)}a(void 0)}))}}function _defineProperty(t,n,r){return n in t?Object.defineProperty(t,n,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[n]=r,t}function ownKeys(t,n){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),r.push.apply(r,i)}return r}function _objectSpread2(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?ownKeys(Object(r),!0).forEach((function(n){_defineProperty(t,n,r[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(r,n))}))}return t}function parseHexToInt(t){return t.match(/[^a-f0-9]/i)?NaN:parseInt(t,16)}function validateAndParseHex(t,n,r){var i=parseHexToInt(t);if(Number.isNaN(i)||void 0!==r&&r!==t.length)throw new SyntaxError(n+": "+t);return i}function parseHexadecimalCode(t){var n=validateAndParseHex(t,"Malformed Hexadecimal",2);return String.fromCharCode(n)}function parseUnicodeCode(t,n){var r=validateAndParseHex(t,"Malformed Unicode",4);if(void 0!==n){var i=validateAndParseHex(n,"Malformed Unicode",4);return String.fromCharCode(r,i)}return String.fromCharCode(r)}function isCurlyBraced(t){return"{"===t.charAt(0)&&"}"===t.charAt(t.length-1)}function parseUnicodeCodePointCode(t){if(!isCurlyBraced(t))throw new SyntaxError("Malformed Unicode: +"+t);var n=validateAndParseHex(t.slice(1,-1),"Malformed Unicode");try{return String.fromCodePoint(n)}catch(t){throw t instanceof RangeError?new SyntaxError("Code Point Limit:"+n):t}}Object.defineProperty(exports,"__esModule",{value:!0});var singleCharacterEscapes=new Map([["b","\b"],["f","\f"],["n","\n"],["r","\r"],["t","\t"],["v","\v"],["0","\0"]]);function parseSingleCharacterCode(t){return singleCharacterEscapes.get(t)||t}var escapeMatch=/\\(?:(\\)|x([\s\S]{0,2})|u(\{[^}]*\}?)|u([\s\S]{4})\\u([^{][\s\S]{0,3})|u([\s\S]{0,4})|([0-3]?[0-7]{1,2})|([\s\S])|$)/g;function unraw(t){return t.replace(escapeMatch,(function(t,n,r,i,o,s,a,c,p){if(void 0!==n)return"\\";if(void 0!==r)return parseHexadecimalCode(r);if(void 0!==i)return parseUnicodeCodePointCode(i);if(void 0!==o)return parseUnicodeCode(o,s);if(void 0!==a)return parseUnicodeCode(a);if("0"===c)return"\0";if(void 0!==c)throw new SyntaxError("Octal Deprecation: "+c);if(void 0!==p)return parseSingleCharacterCode(p);throw new SyntaxError("End of string")}))}var lispTypes=new Map;class ParseError extends Error{constructor(t,n){super(t),this.code=n}}class Lisp{constructor(t){this.op=t.op,this.a=t.a,this.b=t.b}}class If{constructor(t,n){this.t=t,this.f=n}}class KeyVal{constructor(t,n){this.key=t,this.val=n}}class SpreadObject{constructor(t){this.item=t}}class SpreadArray{constructor(t){this.item=t}}var inlineIfElse=/^:/,space=/^\s/,expectTypes={splitter:{types:{split:/^(&&|&(?!&)|\|\||\|(?!\|)|<=|>=|<(?!<)|>(?!>)|!==|!=(?!\=)|===|==(?!\=)|\+(?!\+)|\-(?!\-)|\^|<<|>>(?!>)|>>>|instanceof(?![\w\$\_])|in(?![\w\$\_]))(?!\=)/,op:/^(\/|\*\*|\*(?!\*)|\%)(?!\=)/},next:["modifier","value","prop","incrementerBefore"]},inlineIf:{types:{inlineIf:/^\?/},next:["expEnd"]},assignment:{types:{assignModify:/^(\-=|\+=|\/=|\*\*=|\*=|%=|\^=|\&=|\|=|>>>=|>>=|<<=)/,assign:/^(=)(?!=)/},next:["modifier","value","prop","incrementerBefore"]},incrementerBefore:{types:{incrementerBefore:/^(\+\+|\-\-)/},next:["prop"]},expEdge:{types:{call:/^[\(]/,incrementerAfter:/^(\+\+|\-\-)/},next:["splitter","expEdge","inlineIf","dot","expEnd"]},modifier:{types:{not:/^!/,inverse:/^~/,negative:/^\-(?!\-)/,positive:/^\+(?!\+)/,typeof:/^typeof(?![\w\$\_])/,delete:/^delete(?![\w\$\_])/},next:["modifier","value","prop","incrementerBefore"]},dot:{types:{arrayProp:/^[\[]/,dot:/^\.(?!\.)/},next:["splitter","assignment","expEdge","inlineIf","dot","expEnd"]},prop:{types:{prop:/^[a-zA-Z\$\_][a-zA-Z\d\$\_]*/},next:["splitter","assignment","expEdge","inlineIf","dot","expEnd"]},value:{types:{createObject:/^\{/,createArray:/^\[/,number:/^(0x[\da-f]+|\d+(\.\d+)?(e[\+\-]?\d+)?)/i,string:/^"(\d+)"/,literal:/^`(\d+)`/,regex:/^\/(\d+)\/r(?![\w\$\_])/,boolean:/^(true|false)(?![\w\$\_])/,null:/^null(?![\w\$\_])/,und:/^undefined(?![\w\$\_])/,arrowFunctionSingle:/^(async\s+)?([a-zA-Z\$_][a-zA-Z\d\$_]*)\s*=>\s*({)?/,arrowFunction:/^(async\s*)?\(\s*((\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*(\s*,\s*(\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)*)?\s*\)\s*=>\s*({)?/,inlineFunction:/^(async\s+)?function(\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)?\s*\(\s*((\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*(\s*,\s*(\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)*)?\s*\)\s*{/,group:/^\(/,NaN:/^NaN(?![\w\$\_])/,Infinity:/^Infinity(?![\w\$\_])/,void:/^void(?![\w\$\_])\s*/,await:/^await(?![\w\$\_])\s*/,new:/^new(?![\w\$\_])\s*/,throw:/^throw(?![\w\$\_])\s*/},next:["splitter","expEdge","inlineIf","dot","expEnd"]},initialize:{types:{initialize:/^(var|let|const)\s+([a-zA-Z\$_][a-zA-Z\d\$_]*)\s*(=)?/,return:/^return(?![\w\$\_])/},next:["modifier","value","prop","incrementerBefore","expEnd"]},spreadObject:{types:{spreadObject:/^\.\.\./},next:["value","prop"]},spreadArray:{types:{spreadArray:/^\.\.\./},next:["value","prop"]},expEnd:{types:{},next:[]},expSingle:{types:{for:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*for\s*\(/,do:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*do\s*\{/,while:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*while\s*\(/,loopAction:/^(break|continue)(?![\w\$\_])/,if:/^if\s*\(/,try:/^try\s*{/,function:/^(async\s+)?function(\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)\s*\(\s*((\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*(\s*,\s*(\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)*)?\s*\)\s*{/,switch:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*switch\s*\(/},next:["expEnd"]}},closings={"(":")","[":"]","{":"}","'":"'",'"':'"',"`":"`"},okFirstChars=/^[\+\-~ !]/,aChar=/^[\w\$]/,aNumber=expectTypes.value.types.number;function restOfExp(t,n,r,i,o,s){var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},c=arguments.length>7?arguments[7]:void 0,p=!0;r=r||[];var l,f=!1,u=!1,d=!1,h=!1,y="",g="";for(l=0;l<n.length&&!u;l++){var v=n[l];if(d=h,(h=aChar.test(v))||space.test(v)||closings[v]||(g=""),h&&s&&(g+=v),'"'===i||"'"===i||"`"===i){if("`"!==i||"$"!==v||"{"!==n[l+1]||f){if(v===i&&!f)return n.substring(0,l)}else{var x=restOfExp(t,n.substring(l+2),[],"{");l+=x.length+2}f=!f&&"\\"===v}else if(closings[v]){if(v===o){u=!0;break}var b=restOfExp(t,n.substring(l+1),[],v);if(l+=b.length+1,p=!1,s){var w=n.substring(l);for(var S of s){S.lastIndex=0;var E=S.exec(w);if(E&&(l+=E[1].length-1,a.word=g,u=!0))break}}}else if(i){if(v===closings[i])return n.substring(0,l)}else{var m=n.substring(l),T=void 0;if((T=aNumber.exec(m))&&(l+=T[0].length-1,m=n.substring(l)),c||(!d||!h)&&y!==v)for(var A of r){var O=A.exec(m);if(O){s&&(l+=O[1].length),u=!0;break}}if(p&&(okFirstChars.test(m)?u=!1:p=!1),u)break}y=v}if(i)throw new SyntaxError("Unclosed '"+i+"': "+i+n.substring(0,Math.min(l,40)));return n.substring(0,l)}restOfExp.next=["splitter","expEnd","inlineIf"];var setLispType=(t,n)=>{t.forEach((t=>{lispTypes.set(t,n)}))},closingsCreate={createArray:/^\]/,createObject:/^\}/,group:/^\)/,arrayProp:/^\]/,call:/^\)/};setLispType(["createArray","createObject","group","arrayProp","call"],((t,n,r,i,o,s)=>{for(var a="",c=[],p=!1,l=1;l<r.length&&!p;)l+=(a=restOfExp(t,r.substring(l),[closingsCreate[n],/^,/])).length,a&&c.push(a),","!==r[l]?p=!0:l++;var f,u,d=["value","modifier","prop","incrementerBefore","expEnd"];switch(n){case"group":case"arrayProp":f=lispifyExpr(t,c.join(","));break;case"call":case"createArray":f=c.map((n=>lispify(t,n,[...d,"spreadArray"])));break;case"createObject":f=c.map((n=>{var r,i;if(n=n.trimStart(),u=expectTypes.expSingle.types.function.exec("function "+n))i=u[2].trimStart(),r=lispify(t,"function "+n.replace(i,""));else{var o=restOfExp(t,n,[/^:/]);if((i=lispify(t,o,[...d,"spreadObject"]))instanceof Lisp&&"prop"===i.op&&(i=i.b),o.length===n.length)return i;r=lispify(t,n.substring(o.length+1))}return new Lisp({op:"keyVal",a:i,b:r})}))}n="arrayProp"===n?"prop":n,s.lispTree=lispify(t,r.substring(l+1),expectTypes[o].next,new Lisp({op:n,a:s.lispTree,b:f}))})),setLispType(["inverse","not","negative","positive","typeof","delete","op"],((t,n,r,i,o,s)=>{var a=restOfExp(t,r.substring(i[0].length),[/^[^\s\.\w\d\$]/]);s.lispTree=lispify(t,r.substring(a.length+i[0].length),restOfExp.next,new Lisp({op:["positive","negative"].includes(n)?"$"+i[0]:i[0],a:s.lispTree,b:lispify(t,a,expectTypes[o].next)}))})),setLispType(["incrementerBefore"],((t,n,r,i,o,s)=>{var a=restOfExp(t,r.substring(2),[/^[^\s\.\w\d\$]/]);s.lispTree=lispify(t,r.substring(a.length+2),restOfExp.next,new Lisp({op:i[0]+"$",a:lispify(t,a,expectTypes[o].next)}))})),setLispType(["incrementerAfter"],((t,n,r,i,o,s)=>{s.lispTree=lispify(t,r.substring(i[0].length),expectTypes[o].next,new Lisp({op:"$"+i[0],a:s.lispTree}))})),setLispType(["assign","assignModify"],((t,n,r,i,o,s)=>{s.lispTree=new Lisp({op:i[0],a:s.lispTree,b:lispify(t,r.substring(i[0].length),expectTypes[o].next)})})),setLispType(["split"],((t,n,r,i,o,s)=>{var a=restOfExp(t,r.substring(i[0].length),[expectTypes.splitter.types.split,expectTypes.inlineIf.types.inlineIf,inlineIfElse]);s.lispTree=lispify(t,r.substring(a.length+i[0].length).trim(),restOfExp.next,new Lisp({op:i[0].trim(),a:s.lispTree,b:lispify(t,a,expectTypes[o].next)}))})),setLispType(["inlineIf"],((t,n,r,i,o,s)=>{for(var a=!1,c="",p=1;!a&&c.length<r.length;)c+=restOfExp(t,r.substring(c.length+1),[expectTypes.inlineIf.types.inlineIf,inlineIfElse]),"?"===r[c.length+1]?p++:p--,p?c+=r[c.length+1]:a=!0;s.lispTree=new Lisp({op:"?",a:s.lispTree,b:new Lisp({op:":",a:lispifyExpr(t,c),b:lispifyExpr(t,r.substring(i[0].length+c.length+1))})})})),setLispType(["if"],((t,n,r,i,o,s)=>{var a=restOfExp(t,r.substring(i[0].length),[],"("),c=/^\s*\{/.exec(r.substring(i[0].length+a.length+1)),p=i[0].length+a.length+1+(c?c[0].length:0),l=restOfExp(t,r.substring(p),c?[/^\}/]:[/^else(?!\w\$)/]),f="";if(p+l.length+(c?c[0].length:0)<r.length){var u=r.substring(p+l.length+(c?c[0].length:0)),d=/\s*else(?!\w\$\s)\s*/.exec(u);d&&(f=u.substring(d[0].length))}a=a.trim(),l=l.trim(),f=f.trim(),"{"===l[0]&&(l=l.slice(1,-1)),"{"===f[0]&&(f=f.slice(1,-1)),s.lispTree=new Lisp({op:"if",a:lispifyExpr(t,a),b:new If(lispifyBlock(l,t),f?lispifyBlock(f,t):void 0)})})),setLispType(["switch"],((t,n,r,i,o,s)=>{var a=restOfExp(t,r.substring(i[0].length),[],"("),c=r.indexOf("{",i[0].length+a.length+1);if(-1===c)throw new SyntaxError("Invalid switch: "+r);for(var p,l=insertSemicolons(t,restOfExp(t,r.substring(c+1),[],"{"),!1),f=/^\s*(case\s|default)\s*/,u=[],d=!1;p=f.exec(l);){if("default"===p[1]){if(d)throw new SyntaxError("Only one default switch case allowed:"+l);d=!0}var h=restOfExp(t,l.substring(p[0].length),[/^:/]),y="",g=c=p[0].length+h.length+1,v=/^\s*\{/.exec(l.substring(g)),x=[];if(v)g+=v[0].length,g+=(y=restOfExp(t,l.substring(g),[],"{")).length+1,x=lispifyBlock(y,t);else{var b=restOfExp(t,l.substring(g),[f]);if(b.trim()){for(var w=[];(y=restOfExp(t,l.substring(g),[/^;/]))&&(w.push(y),g+=y.length+1,!f.test(l.substring(g))););x=lispifyBlock(w.join(";"),t)}else x=void 0,g+=b.length}l=l.substring(g),u.push(new Lisp({op:"case",a:"default"===p[1]?void 0:lispifyExpr(t,h),b:x}))}s.lispTree=new Lisp({op:"switch",a:lispifyExpr(t,a),b:u})})),setLispType(["dot","prop"],((t,n,r,i,o,s)=>{var a=i[0],c=i[0].length;if("."===i[0]){var p=r.substring(i[0].length).match(expectTypes.prop.types.prop);if(!p||!p.length)throw new SyntaxError("Hanging  dot:"+r);c=(a=p[0]).length+i[0].length}s.lispTree=lispify(t,r.substring(c),expectTypes[o].next,new Lisp({op:"prop",a:s.lispTree,b:a}))})),setLispType(["spreadArray","spreadObject"],((t,n,r,i,o,s)=>{s.lispTree=new Lisp({op:n,b:lispify(t,r.substring(i[0].length),expectTypes[o].next)})})),setLispType(["return"],((t,n,r,i,o,s)=>{s.lispTree=new Lisp({op:n,b:lispifyExpr(t,r.substring(i[0].length))})}));var primitives={true:!0,false:!1,null:null,Infinity:1/0,NaN:NaN,und:void 0};setLispType(["number","boolean","null","und","NaN","Infinity"],((t,n,r,i,o,s)=>{s.lispTree=lispify(t,r.substring(i[0].length),expectTypes[o].next,"number"===n?Number(i[0]):primitives["boolean"===n?i[0]:n])})),setLispType(["string","literal","regex"],((t,n,r,i,o,s)=>{s.lispTree=lispify(t,r.substring(i[0].length),expectTypes[o].next,new Lisp({op:n,b:parseInt(JSON.parse(i[1]),10)}))})),setLispType(["initialize"],((t,n,r,i,o,s)=>{i[3]?s.lispTree=new Lisp({op:i[1],a:i[2],b:lispify(t,r.substring(i[0].length),expectTypes[o].next)}):s.lispTree=lispify(t,r.substring(i[0].length),expectTypes[o].next,new Lisp({op:i[1],a:i[2]}))})),setLispType(["function","inlineFunction","arrowFunction","arrowFunctionSingle"],((t,n,r,i,o,s)=>{var a="function"!==n&&"inlineFunction"!==n,c=a&&!i[i.length-1],p=a?2:3,l=!!i[1],f=i[p]?i[p].replace(/\s+/g,"").split(/,/g):[];a||f.unshift((i[2]||"").trimStart());var u=!1;f.forEach((t=>{if(u)throw new SyntaxError("Rest parameter must be last formal parameter");t.startsWith("...")&&(u=!0)})),f.unshift(l);var d=(c?"return ":"")+restOfExp(t,r.substring(i[0].length),c?[/^[,;\)\}\]]/]:[/^}/]);s.lispTree=lispify(t,r.substring(i[0].length+d.length+1),expectTypes[o].next,new Lisp({op:a?"arrowFunc":n,a:f,b:lispifyFunction(d,t)}))}));var iteratorRegex=/^((let|var|const)\s+)?\s*([a-zA-Z\$_][a-zA-Z\d\$_]*)\s+(in|of)\s+/;setLispType(["for","do","while"],((t,n,r,i,o,s)=>{var a,c,p=r.indexOf("(")+1,l=!0,f=[],u=!1,d=!0,h=!0;switch(n){case"while":var y=restOfExp(t,r.substring(p),[],"(");a=lispifyExpr(t,y),"{"===(c=restOfExp(t,r.substring(p+y.length+1)).trim())[0]&&(c=c.slice(1,-1));break;case"for":for(var g,v=[],x="",b=0;b<3&&(x=restOfExp(t,r.substring(p),[/^[;\)]/]),v.push(x.trim()),")"!==r[(p+=x.length+1)-1]);b++);if(1===v.length&&(g=iteratorRegex.exec(v[0])))"of"===g[4]?(f=[lispify(t,"let $$obj = "+v[0].substring(g[0].length),["initialize"]),ofStart2,ofStart3],a=ofCondition,h=ofStep,u=lispify(t,(g[1]||"let ")+g[3]+" = $$next.value",["initialize"])):(f=[lispify(t,"let $$obj = "+v[0].substring(g[0].length),["initialize"]),inStart2,inStart3],h=inStep,a=inCondition,u=lispify(t,(g[1]||"let ")+g[3]+" = $$keys[$$keyIndex]",["initialize"]));else{if(3!==v.length)throw new SyntaxError("Invalid for loop definition");l=lispifyExpr(t,v.shift(),startingExecpted),a=lispifyExpr(t,v.shift()),h=lispifyExpr(t,v.shift())}"{"===(c=restOfExp(t,r.substring(p)).trim())[0]&&(c=c.slice(1,-1));break;case"do":d=!1;var w=r.indexOf("{")+1;c=restOfExp(t,r.substring(w),[],"{"),a=lispifyExpr(t,restOfExp(t,r.substring(r.indexOf("(",w+c.length)+1),[],"("))}s.lispTree=new Lisp({op:"loop",a:[d,f,l,h,a,u],b:lispifyBlock(c,t)})})),setLispType(["block"],((t,n,r,i,o,s)=>{s.lispTree=lispifyBlock(restOfExp(t,r.substring(1),[],"{"),t)})),setLispType(["loopAction"],((t,n,r,i,o,s)=>{s.lispTree=new Lisp({op:"loopAction",a:i[1]})}));var catchReg=/^\s*(catch\s*(\(\s*([a-zA-Z\$_][a-zA-Z\d\$_]*)\s*\))?|finally)\s*\{/;setLispType(["try"],((t,n,r,i,o,s)=>{var a,c,p,l=restOfExp(t,r.substring(i[0].length),[],"{"),f=catchReg.exec(r.substring(i[0].length+l.length+1)),u=0;f[1].startsWith("catch")?(c=(f=catchReg.exec(r.substring(i[0].length+l.length+1)))[2],p=restOfExp(t,r.substring(i[0].length+l.length+1+f[0].length),[],"{"),u=i[0].length+l.length+1+f[0].length+p.length+1,(f=catchReg.exec(r.substring(u)))&&f[1].startsWith("finally")&&(a=restOfExp(t,r.substring(u+f[0].length),[],"{"))):a=restOfExp(t,r.substring(i[0].length+l.length+1+f[0].length),[],"{"),s.lispTree=new Lisp({op:"try",a:lispifyBlock(insertSemicolons(t,l,!1),t),b:[c,lispifyBlock(insertSemicolons(t,p||"",!1),t),lispifyBlock(insertSemicolons(t,a||"",!1),t)]})})),setLispType(["void","await","throw"],((t,n,r,i,o,s)=>{var a=restOfExp(t,r.substring(i[0].length),[/^[^\s\.\w\d\$]/]);s.lispTree=lispify(t,r.substring(i[0].length+a.length),expectTypes[o].next,new Lisp({op:n,a:lispify(t,a)}))})),setLispType(["new"],((t,n,r,i,o,s)=>{var a=i[0].length,c=restOfExp(t,r.substring(a),[],void 0,"("),p=[];if("("===r[(a+=c.length+1)-1]){var l,f=restOfExp(t,r.substring(a),[],"(");a+=f.length+1;for(var u=0;l=restOfExp(t,f.substring(u),[/^,/]);)u+=l.length+1,p.push(l.trim())}s.lispTree=lispify(t,r.substring(a),expectTypes.expEdge.next,new Lisp({op:n,a:lispify(t,c,expectTypes.initialize.next),b:p.map((n=>lispify(t,n,expectTypes.initialize.next)))}))}));var ofStart2=lispify(void 0,"let $$iterator = $$obj[Symbol.iterator]()",["initialize"]),ofStart3=lispify(void 0,"let $$next = $$iterator.next()",["initialize"]),ofCondition=lispify(void 0,"return !$$next.done",["initialize"]),ofStep=lispify(void 0,"$$next = $$iterator.next()"),inStart2=lispify(void 0,"let $$keys = Object.keys($$obj)",["initialize"]),inStart3=lispify(void 0,"let $$keyIndex = 0",["initialize"]),inStep=lispify(void 0,"$$keyIndex++"),inCondition=lispify(void 0,"return $$keyIndex < $$keys.length",["initialize"]),startingExecpted=["initialize","expSingle","value","modifier","prop","incrementerBefore","expEnd"],lastType,lastPart;function lispify(t,n,r,i){if(r=r||expectTypes.initialize.next,void 0===n)return i;if(!(n=n.trimStart()).length&&!r.includes("expEnd"))throw new SyntaxError("Unexpected end of expression: "+lastPart);if(!n)return i;var o,s={lispTree:i};for(var a of r)if("expEnd"!==a){for(var c in expectTypes[a].types)if("expEnd"!==c&&(o=expectTypes[a].types[c].exec(n))){lastType=c,lastPart=n,lispTypes.get(c)(t,c,n,o,a,s);break}if(o)break}if(!o&&n.length)throw SyntaxError("Unexpected token (".concat(lastType,"): ").concat(n.substring(0,40)));return s.lispTree}function lispifyExpr(t,n,r){if(n.trim()){var i,o=[],s=0;for(r=r||expectTypes.initialize.next;i=restOfExp(t,n.substring(s),[/^,/]);)o.push(i.trimStart()),s+=i.length+1;if(1===o.length)return lispify(t,n,r);if(r===startingExecpted){var a=expectTypes.initialize.types.initialize.exec(o[0]);if(a)return o.map(((n,r)=>lispify(t,r?a[1]+" "+n:n,["initialize"])));if(expectTypes.initialize.types.return.exec(o[0]))return lispify(t,n,r)}var c=o.map(((n,i)=>lispify(t,n,r)));return new Lisp({op:"multi",a:c})}}function lispifyBlock(t,n){if(!(t=insertSemicolons(n,t,!1)).trim())return[];for(var r,i=[],o=0;r=restOfExp(n,t.substring(o),[/^;/]);)i.push(r.trim()),o+=r.length+1;return i.filter(Boolean).map(((t,r)=>lispifyExpr(n,t,startingExecpted))).flat()}function lispifyFunction(t,n){if(!t.trim())return[];var r=lispifyBlock(t,n),i=[];return hoist(r,i),i.concat(r)}function hoist(t,n){if(Array.isArray(t)){var r=[];for(var i of t)hoist(i,n)||r.push(i);r.length!==t.length&&(t.length=0,t.push(...r))}else if(t instanceof Lisp)if("try"===t.op||"if"===t.op||"loop"===t.op||"switch"===t.op)hoist(t.a,n),hoist(t.b,n);else if("var"===t.op)n.push(new Lisp({op:"var",a:t.a}));else if("function"===t.op&&t.a[1])return n.push(t),!0;return!1}var edgesForInsertion=[/^([\w\$]|\+\+|\-\-)\s*\r?\n\s*([\w\$\+\-])/,/^([^\w\$](return|continue|break|throw))\s*\r?\n\s*[^\s]/],closingsForInsertion=[/^([\)\]])\s*\r?\n\s*([\w\$\{\+\-])/,/^(\})\s*\r?\n?\s*([\(])/,/^(\})\s*(\r?\n)?\s*([\w\[\+\-])/],closingsNoInsertion=/^(\})\s*(catch|finally|else|while|instanceof)(?![\w\$])/,whileEnding=/^\}\s*while/;function insertSemicolons(t,n,r){for(var i=n,o="",s=[],a={};o=restOfExp(t,i,edgesForInsertion,void 0,void 0,r?void 0:closingsForInsertion,a,!0);)s.push(o),closingsNoInsertion.test(i.substring(o.length-1))?"do"!==a.word&&whileEnding.test(i.substring(o.length-1))&&s.push(";"):s.push(";"),i=i.substring(o.length);return s.pop(),s.join("")}var oneLinerBlocks=/[^\w\$](if|do)(?![\w\$])/g;function convertOneLiners(t,n){for(var r,i=0,o=[];r=oneLinerBlocks.exec(n);){var s=n.substring(r.index+r[0].length),a=r.index+r[0].length;if("if"===r[1]){var c=s.indexOf("(")+1;a+=c;var p=restOfExp(t,s.substring(c),[],"(");oneLinerBlocks.lastIndex=r.index+c+p.length+1,o.push(n.substring(i,a),[p],")"),a+=p.length+1}else o.push(n.substring(i,a));if(a+=/^\s*/.exec(n.substring(a))[0].length,"{"!==(s=n.substring(a))[0]){var l=restOfExp(t,s,[/^([;\)\]\}]|\r?\n)/]),f=0;";"===s[l.length]&&(f=1),o.push("{",l,"}");var u=s.substring(l.length+f);"if"!==r[1]||/^\s*else(?![\w\$])/.test(u)||o.push(";"),i=a+l.length+f}else i=a}for(var d of(o.push(n.substring(i)),o))if(d instanceof Array){var h=convertOneLiners(t,d[0]);d.length=0,d.push(h)}return o.flat().join("")}function checkRegex(t){for(var n=1,r=!1,i=!1,o=!1;n<t.length&&!i&&!o;)i="/"===t[n]&&!r,r="\\"===t[n]&&!r,o="\n"===t[n],n++;var s=t.substring(n);if(o=o||!i||/^\s*\d/.test(s))return null;var a=/^[a-z]*/.exec(s);return/^\s+[\w\$]/.test(t.substring(n+a[0].length))?null:{regex:t.substring(1,n-1),flags:a&&a[0]||"",length:n+(a&&a[0].length||0)}}var notDivide=/(typeof|delete|instanceof|return|in|of|throw|new|void|do|if)$/,possibleDivide=/^([\w\$\]\)]|\+\+|\-\-)[^\w\$\]\)\+\-]/;function extractConstants(t,n){for(var r,i,o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",a=[],c=!1,p="",l=-1,f=[],u="",d=[],h=[],y=0;y<n.length;y++)if(u=n[y],p)u===p&&("*"===p&&"/"===n[y+1]?(p="",y++):"\n"===p&&(p=""));else{if(c){c=!1,a.push(u);continue}if(r)if("`"===r&&"$"===u&&"{"===n[y+1]){var g=extractConstants(t,n.substring(y+2),"{");f.push(g.str),a.push("${".concat(f.length-1,"}")),y+=g.length+2}else r===u?("`"===r?(t.literals.push({op:"literal",a:unraw(a.join("")),b:f}),d.push("`".concat(t.literals.length-1,"`"))):(t.strings.push(unraw(a.join(""))),d.push('"'.concat(t.strings.length-1,'"'))),r=null,a=[]):a.push(u);else{if("'"===u||'"'===u||"`"===u)f=[],r=u;else{if(closings[s]===u&&!h.length)return{str:d.join(""),length:y};closings[u]?(h.push(u),d.push(u)):closings[h[h.length-1]]===u?(h.pop(),d.push(u)):"/"!==u||"*"!==n[y+1]&&"/"!==n[y+1]?"/"===u&&!o&&(i=checkRegex(n.substring(y)))?(t.regexes.push(i),d.push("/".concat(t.regexes.length-1,"/r")),y+=i.length-1):d.push(u):(p="*"===n[y+1]?"*":"\n",l=y)}o&&space.test(u)||(o=possibleDivide.exec(n.substring(y)))&&notDivide.test(n.substring(0,y+o[1].length))&&(o=null)}c=r&&"\\"===u}if(p&&"*"===p)throw new SyntaxError("Unclosed comment '/*': ".concat(n.substring(l)));return{str:d.join(""),length:y}}function parse(t){if("string"!=typeof t)throw new ParseError("Cannot parse ".concat(t),t);var n=" "+t,r={strings:[],literals:[],regexes:[]};n=extractConstants(r,n).str,n=insertSemicolons(r,n,!0),n=convertOneLiners(r,n);try{for(var i of r.literals)i.b=i.b.map((t=>lispifyExpr(r,t)));return{tree:lispifyFunction(n,r),constants:r}}catch(t){throw t}}class ExecReturn{constructor(t,n,r){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.auditReport=t,this.result=n,this.returned=r,this.breakLoop=i,this.continueLoop=o}}class Prop{constructor(t,n){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.context=t,this.prop=n,this.isConst=r,this.isGlobal=i,this.isVariable=o}}var reservedWords=new Set(["instanceof","typeof","return","try","catch","if","finally","else","in","of","var","let","const","for","delete","false","true","while","do","break","continue","new","function","async","await","switch","case"]),VarType,e;e=VarType||(VarType={}),e.let="let",e.const="const",e.var="var";class Scope{constructor(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2?arguments[2]:void 0;this.const=new Set,this.let=new Set;var i=void 0!==r||null===t;this.parent=t,this.allVars=n,this.let=i?this.let:new Set(Object.keys(n)),this.var=i?new Set(Object.keys(n)):this.var,this.globals=null===t?new Set(Object.keys(n)):new Set,this.functionThis=r}get(t){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("this"===t&&void 0!==this.functionThis)return new Prop({this:this.functionThis},t,!0,!1,!0);if(reservedWords.has(t))throw new SyntaxError("Unexepected token '"+t+"'");if(null===this.parent||!n||void 0!==this.functionThis){if(this.globals.has(t))return new Prop(this.functionThis,t,!1,!0,!0);if(t in this.allVars&&(!(t in{})||this.allVars.hasOwnProperty(t)))return new Prop(this.allVars,t,this.const.has(t),this.globals.has(t),!0);if(null===this.parent)return new Prop(void 0,t)}return this.parent.get(t,n)}set(t,n){if("this"===t)throw new SyntaxError('"this" cannot be assigned');if(reservedWords.has(t))throw new SyntaxError("Unexepected token '"+t+"'");var r=this.get(t);if(void 0===r.context)throw new ReferenceError("Variable '".concat(t,"' was not declared."));if(r.isConst)throw new TypeError("Cannot assign to const variable '".concat(t,"'"));if(r.isGlobal)throw new SandboxError("Cannot override global variable '".concat(t,"'"));return r.context[r]=n,r}declare(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("this"===t)throw new SyntaxError('"this" cannot be declared');if(reservedWords.has(t))throw new SyntaxError("Unexepected token '"+t+"'");if("var"===n&&void 0===this.functionThis&&null!==this.parent)return this.parent.declare(t,n,r,i);if((!this[n].has(t)||"const"===n||this.globals.has(t))&&t in this.allVars)throw new SandboxError("Identifier '".concat(t,"' has already been declared"));return i&&this.globals.add(t),this[n].add(t),this.allVars[t]=r,new Prop(this.allVars,t,this.const.has(t),i)}}class SandboxError extends Error{}function sandboxFunction(t){return function(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];var o=r.pop()||"",s=parse(o);return createFunction(r,s.tree,{ctx:t,constants:s.constants},void 0,"anonymous")}}var sandboxedFunctions=new WeakSet;function createFunction(t,n,r,i,o){var s=function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];var p={};t.forEach(((t,n)=>{t.startsWith("...")?p[t.substring(3)]=a.slice(n):p[t]=a[n]}));var l=executeTree(r,n,void 0===i?[]:[new Scope(i,p,void 0===o?void 0:this)]);return l.result};return sandboxedFunctions.add(s),s}function createFunctionAsync(t,n,r,i,o){var s=function(){var s=_asyncToGenerator((function*(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];var p={};t.forEach(((t,n)=>{t.startsWith("...")?p[t.substring(3)]=a.slice(n):p[t]=a[n]}));var l=yield executeTreeAsync(r,n,void 0===i?[]:[new Scope(i,p,void 0===o?void 0:this)]);return l.result}));return function(){return s.apply(this,arguments)}}();return sandboxedFunctions.add(s),s}function sandboxedEval(t){return function(n){return t(n)()}}function sandboxedSetTimeout(t){return function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return"string"!=typeof n?setTimeout(n,...i):setTimeout(t(n),...i)}}function sandboxedSetInterval(t){return function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return"string"!=typeof n?setInterval(n,...i):setInterval(t(n),...i)}}function assignCheck(t,n){var r,i,o,s,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"assign";if(void 0===t.context)throw new ReferenceError("Cannot ".concat(a," value to undefined."));if("object"!=typeof t.context&&"function"!=typeof t.context)throw new SyntaxError("Cannot ".concat(a," value to a primitive."));if(t.isConst)throw new TypeError("Cannot set value to const variable '".concat(t.prop,"'"));if(t.isGlobal)throw new SandboxError("Cannot ".concat(a," property '").concat(t.prop,"' of a global object"));if("function"==typeof t.context[t.prop]&&!t.context.hasOwnProperty(t.prop))throw new SandboxError("Override prototype property '".concat(t.prop,"' not allowed"));"delete"===a?t.context.hasOwnProperty(t.prop)&&(null===(r=n.ctx.changeSubscriptions.get(t.context))||void 0===r||r.forEach((n=>n({type:"delete",prop:t.prop})))):t.context.hasOwnProperty(t.prop)?null===(o=null===(i=n.ctx.setSubscriptions.get(t.context))||void 0===i?void 0:i.get(t.prop))||void 0===o||o.forEach((t=>t({type:"replace"}))):null===(s=n.ctx.changeSubscriptions.get(t.context))||void 0===s||s.forEach((n=>n({type:"create",prop:t.prop})))}var arrayChange=new Set([[].push,[].pop,[].shift,[].unshift,[].splice,[].reverse,[].sort,[].copyWithin]),literalRegex=/(\$\$)*(\$)?\${(\d+)}/g,ops2={prop:(t,n,r,i,o,s,a)=>{if(null===r)throw new TypeError("Cannot get property ".concat(i," of null"));var c=typeof r;if("undefined"===c&&void 0===o){var p=a.get(i);if(void 0===p.context)throw new ReferenceError("".concat(i," is not defined"));if(p.context===s.ctx.sandboxGlobal){s.ctx.options.audit&&s.ctx.auditReport.globalsAccess.add(i);var l=s.ctx.globalsWhitelist.has(s.ctx.sandboxGlobal[i])?s.ctx.evals.get(s.ctx.sandboxGlobal[i]):void 0;if(l)return void n(void 0,l)}return p.context&&p.context[i]===globalThis?void n(void 0,s.ctx.globalScope.get("this")):(s.ctx.getSubscriptions.forEach((t=>t(p.context,p.prop))),void n(void 0,p))}if(void 0===r)throw new SandboxError("Cannot get property '"+i+"' of undefined");if("object"!==c)"number"===c?r=new Number(r):"string"===c?r=new String(r):"boolean"===c&&(r=new Boolean(r));else if(void 0===r.hasOwnProperty)return void n(void 0,new Prop(void 0,i));var f="function"===c,u=f||!(r.hasOwnProperty(i)||"number"==typeof i);if(s.ctx.options.audit&&u&&"string"==typeof i){var d=r.constructor.prototype;do{d.hasOwnProperty(i)&&(s.ctx.auditReport.prototypeAccess[d.constructor.name]||(s.ctx.auditReport.prototypeAccess[d.constructor.name]=new Set),s.ctx.auditReport.prototypeAccess[d.constructor.name].add(i))}while(d=Object.getPrototypeOf(d))}if(u)if(f){if(!["name","length","constructor"].includes(i)&&r.hasOwnProperty(i)){var h=s.ctx.prototypeWhitelist.get(r),y=s.ctx.prototypeReplacements.get(r);if(y)return void n(void 0,new Prop(y(r,!0),i));if(!h||h.size&&!h.has(i))throw new SandboxError("Static method or property access not permitted: ".concat(r.name,".").concat(i))}}else if("constructor"!==i){var g=r.constructor.prototype;do{if(g.hasOwnProperty(i)){var v=s.ctx.prototypeWhitelist.get(g.constructor),x=s.ctx.prototypeReplacements.get(g.constuctor);if(x)return void n(void 0,new Prop(x(r,!1),i));if(v&&(!v.size||v.has(i)))break;throw new SandboxError("Method or property access not permitted: ".concat(g.constructor.name,".").concat(i))}}while(g=Object.getPrototypeOf(g))}var b=s.ctx.globalsWhitelist.has(r[i])?s.ctx.evals.get(r[i]):void 0;if(b)n(void 0,b);else if(r[i]!==globalThis){var w=o.isGlobal||f&&!sandboxedFunctions.has(r)||s.ctx.globalsWhitelist.has(r);w||s.ctx.getSubscriptions.forEach((t=>t(r,i))),n(void 0,new Prop(r,i,!1,w))}else n(void 0,s.ctx.globalScope.get("this"))},call:(t,n,r,i,o,s,a)=>{if(s.ctx.options.forbidMethodCalls)throw new SandboxError("Method calls are not allowed");if("function"!=typeof r)throw new TypeError("".concat(o.prop," is not a function"));execMany(t,i.map((t=>t instanceof SpreadArray?[...t.item]:[t])).flat(),((t,r)=>{var i;if(t)n(t);else if("function"!=typeof o){if(o.context[o.prop]===JSON.stringify&&s.ctx.getSubscriptions.size){var a=new Set,c=t=>{if(t&&"object"==typeof t&&!a.has(t)){a.add(t);var n=function(n){s.ctx.getSubscriptions.forEach((r=>r(t,n))),c(t[n])};for(var r in t)n(r)}};c(r[0])}if(o.context instanceof Array&&arrayChange.has(o.context[o.prop])&&s.ctx.changeSubscriptions.get(o.context)){var p,l=!1;if("push"===o.prop)p={type:"push",added:r},l=!!r.length;else if("pop"===o.prop)l=!!(p={type:"pop",removed:o.context.slice(-1)}).removed.length;else if("shift"===o.prop)l=!!(p={type:"shift",removed:o.context.slice(0,1)}).removed.length;else if("unshift"===o.prop)p={type:"unshift",added:r},l=!!r.length;else if("splice"===o.prop)l=!!(p={type:"splice",startIndex:r[0],deleteCount:void 0===r[1]?o.context.length:r[1],added:r.slice(2),removed:o.context.slice(r[0],void 0===r[1]?void 0:r[0]+r[1])}).added.length||!!p.removed.length;else if("reverse"===o.prop||"sort"===o.prop)p={type:o.prop},l=!!o.context.length;else if("copyWithin"===o.prop){var f=void 0===r[2]?o.context.length-r[1]:Math.min(o.context.length,r[2]-r[1]);l=!!(p={type:"copyWithin",startIndex:r[0],endIndex:r[0]+f,added:o.context.slice(r[1],r[1]+f),removed:o.context.slice(r[0],r[0]+f)}).added.length||!!p.removed.length}l&&(null===(i=s.ctx.changeSubscriptions.get(o.context))||void 0===i||i.forEach((t=>t(p))))}n(void 0,o.context[o.prop](...r))}else n(void 0,o(...r))}),a,s)},createObject:(t,n,r,i,o,s,a)=>{var c={};for(var p of i)p instanceof SpreadObject?c=_objectSpread2(_objectSpread2({},c),p.item):c[p.key]=p.val;n(void 0,c)},keyVal:(t,n,r,i)=>n(void 0,new KeyVal(r,i)),createArray:(t,n,r,i,o,s,a)=>{execMany(t,i.map((t=>t instanceof SpreadArray?[...t.item]:[t])).flat(),n,a,s)},group:(t,n,r,i)=>n(void 0,i),string:(t,n,r,i,o,s)=>n(void 0,s.constants.strings[i]),regex:(t,n,r,i,o,s)=>{var a=s.constants.regexes[i];if(!s.ctx.globalsWhitelist.has(RegExp))throw new SandboxError("Regex not permitted");n(void 0,new RegExp(a.regex,a.flags))},literal:(t,n,r,i,o,s,a)=>{for(var c,p=s.constants.literals[i].a,l=[],f=[];c=literalRegex.exec(p);)c[2]||(l.push(s.constants.literals[i].b[parseInt(c[3],10)]),f.push(c[3]));execMany(t,l,((t,r)=>{var i={};if(t)n(t);else{for(var o in f){var s=f[o];i[s]=r[o]}n(void 0,p.replace(/(\\\\)*(\\)?\${(\d+)}/g,((t,n,r,o)=>{if(r)return t;var s=i[o];return s=s instanceof Prop?s.context[s.prop]:s,(n||"")+"".concat(s)})))}}),a,s)},spreadArray:(t,n,r,i,o,s,a)=>{t(i,a,s,((t,r)=>{t?n(t):n(void 0,new SpreadArray(r))}))},spreadObject:(t,n,r,i,o,s,a)=>{t(i,a,s,((t,r)=>{t?n(t):n(void 0,new SpreadObject(r))}))},"!":(t,n,r,i)=>n(void 0,!i),"~":(t,n,r,i)=>n(void 0,~i),"++$":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,++o.context[o.prop])},"$++":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]++)},"--$":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,--o.context[o.prop])},"$--":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]--)},"=":(t,n,r,i,o,s)=>{assignCheck(o,s),o.context[o.prop]=i,n(void 0,new Prop(o.context,o.prop,!1,o.isGlobal))},"+=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]+=i)},"-=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]-=i)},"/=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]/=i)},"*=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]*=i)},"**=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]**=i)},"%=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]%=i)},"^=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]^=i)},"&=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]&=i)},"|=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]|=i)},"<<=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]<<=i)},">>=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]>>=i)},">>>=":(t,n,r,i,o,s)=>{assignCheck(o,s),n(void 0,o.context[o.prop]>>=i)},"?":(t,n,r,i)=>{if(!(i instanceof If))throw new SyntaxError("Invalid inline if");n(void 0,r?i.t:i.f)},">":(t,n,r,i)=>n(void 0,r>i),"<":(t,n,r,i)=>n(void 0,r<i),">=":(t,n,r,i)=>n(void 0,r>=i),"<=":(t,n,r,i)=>n(void 0,r<=i),"==":(t,n,r,i)=>n(void 0,r==i),"===":(t,n,r,i)=>n(void 0,r===i),"!=":(t,n,r,i)=>n(void 0,r!=i),"!==":(t,n,r,i)=>n(void 0,r!==i),"&&":(t,n,r,i)=>n(void 0,r&&i),"||":(t,n,r,i)=>n(void 0,r||i),"&":(t,n,r,i)=>n(void 0,r&i),"|":(t,n,r,i)=>n(void 0,r|i),":":(t,n,r,i)=>n(void 0,new If(r,i)),"+":(t,n,r,i)=>n(void 0,r+i),"-":(t,n,r,i)=>n(void 0,r-i),"$+":(t,n,r,i)=>n(void 0,+i),"$-":(t,n,r,i)=>n(void 0,-i),"/":(t,n,r,i)=>n(void 0,r/i),"^":(t,n,r,i)=>n(void 0,r^i),"*":(t,n,r,i)=>n(void 0,r*i),"%":(t,n,r,i)=>n(void 0,r%i),"<<":(t,n,r,i)=>n(void 0,r<<i),">>":(t,n,r,i)=>n(void 0,r>>i),">>>":(t,n,r,i)=>n(void 0,r>>>i),typeof:(t,n,r,i)=>n(void 0,typeof i),instanceof:(t,n,r,i)=>n(void 0,r instanceof i),in:(t,n,r,i)=>n(void 0,r in i),delete:(t,n,r,i,o,s,a,c)=>{void 0!==c.context?(assignCheck(c,s,"delete"),c.isVariable?n(void 0,!1):n(void 0,delete c.context[c.prop])):n(void 0,!0)},return:(t,n,r,i,o,s)=>n(void 0,i),var:(t,n,r,i,o,s,a,c)=>{t(i,a,s,((t,i)=>{t?n(t):n(void 0,a.declare(r,VarType.var,i))}))},let:(t,n,r,i,o,s,a,c)=>{t(i,a,s,((t,i)=>{t?n(t):n(void 0,a.declare(r,VarType.let,i,c&&c.isGlobal))}))},const:(t,n,r,i,o,s,a,c)=>{t(i,a,s,((t,i)=>{t?n(t):n(void 0,a.declare(r,VarType.const,i))}))},arrowFunc:(t,n,r,i,o,s,a)=>{r.shift()?n(void 0,createFunctionAsync(r,i,s,a)):n(void 0,createFunction(r,i,s,a))},function:(t,n,r,i,o,s,a)=>{var c,p=r.shift(),l=r.shift();c=p?createFunctionAsync(r,i,s,a,l):createFunction(r,i,s,a,l),l&&a.declare(l,VarType.var,c),n(void 0,c)},inlineFunction:(t,n,r,i,o,s,a)=>{var c,p=r.shift(),l=r.shift();l&&(a=new Scope(a,{})),c=p?createFunctionAsync(r,i,s,a,l):createFunction(r,i,s,a,l),l&&a.declare(l,VarType.let,c),n(void 0,c)},loop:(t,n,r,i,o,s,a)=>{var[c,p,l,f,u,d]=r,h=!0,y=new Scope(a,{}),g=new Scope(y,{});if(t===execAsync)_asyncToGenerator((function*(){yield asyncDone((n=>t(l,y,s,n))),yield asyncDone((n=>t(p,g,s,n))),c&&(h=(yield asyncDone((n=>t(u,g,s,n)))).result);for(var r=function*(){var r={};yield asyncDone((n=>t(d,new Scope(g,r),s,n)));var o=yield executeTreeAsync(s,i,[new Scope(y,r)],"loop");return o instanceof ExecReturn&&o.returned?(n(void 0,o),{v:void 0}):o instanceof ExecReturn&&o.breakLoop?"break":(yield asyncDone((n=>t(f,g,s,n))),void(h=(yield asyncDone((n=>t(u,g,s,n)))).result))};h;){var o=yield*r();if("break"===o)break;if("object"==typeof o)return o.v}n()}))().catch(n);else{syncDone((n=>t(l,y,s,n))),syncDone((n=>t(p,g,s,n))),c&&(h=syncDone((n=>t(u,g,s,n))).result);for(var v=function(){var r={};syncDone((n=>t(d,new Scope(g,r),s,n)));var o=executeTree(s,i,[new Scope(y,r)],"loop");return o instanceof ExecReturn&&o.returned?(n(void 0,o),{v:void 0}):o instanceof ExecReturn&&o.breakLoop?"break":(syncDone((n=>t(f,g,s,n))),void(h=syncDone((n=>t(u,g,s,n))).result))};h;){var x=v();if("break"===x)break;if("object"==typeof x)return x.v}n()}},loopAction:(t,n,r,i,o,s,a)=>{if("switch"===s.inLoopOrSwitch&&"continue"===r||!s.inLoopOrSwitch)throw new SandboxError("Illegal "+r+" statement");n(void 0,new ExecReturn(s.ctx.auditReport,void 0,!1,"break"===r,"continue"===r))},if:(t,n,r,i,o,s,a)=>{if(!(i instanceof If))throw new SyntaxError("Invalid if");t(r,a,s,((r,o)=>{r?n(r):executeTreeWithDone(t,n,s,o?i.t:i.f,[new Scope(a)],s.inLoopOrSwitch)}))},switch:(t,n,r,i,o,s,a)=>{t(r,a,s,((r,o)=>{if(r)n(r);else if(t===execSync){var c,p=!1,l=function(r){if(p||(p=!r.a||o===valueOrProp(syncDone((n=>t(r.a,a,s,n))).result))){if(!r.b)return"continue";if((c=executeTree(s,r.b,[a],"switch")).breakLoop)return"break";if(c.returned)return n(void 0,c),{v:void 0};if(!r.a)return"break"}};for(var f of i){var u=l(f);if("continue"!==u){if("break"===u)break;if("object"==typeof u)return u.v}}n()}else _asyncToGenerator((function*(){var r,c=!1,p=function*(i){if(c||(c=!i.a||o===valueOrProp((yield asyncDone((n=>t(i.a,a,s,n)))).result))){if(!i.b)return"continue";if((r=yield executeTreeAsync(s,i.b,[a],"switch")).breakLoop)return"break";if(r.returned)return n(void 0,r),{v:void 0};if(!i.a)return"break"}};for(var l of i){var f=yield*p(l);if("continue"!==f){if("break"===f)break;if("object"==typeof f)return f.v}}n()}))().catch(n)}))},try:(t,n,r,i,o,s,a)=>{var[c,p,l]=i;executeTreeWithDone(t,((r,i)=>{executeTreeWithDone(t,(o=>{o?n(o):r?executeTreeWithDone(t,n,s,p,[new Scope(a)],s.inLoopOrSwitch):n(void 0,i)}),s,l,[new Scope(a,{})])}),s,r,[new Scope(a)],s.inLoopOrSwitch)},void:(t,n,r)=>{n()},new:(t,n,r,i,o,s)=>{if(!s.ctx.globalsWhitelist.has(r)&&!sandboxedFunctions.has(r))throw new SandboxError("Object construction not allowed: ".concat(r.constructor.name));n(void 0,new r(...i))},throw:(t,n,r)=>{n(r)},multi:(t,n,r,i,o,s,a)=>n(void 0,r.pop())},ops=new Map;for(var op in ops2)ops.set(op,ops2[op]);function valueOrProp(t){return t instanceof Prop?t.context[t.prop]:t}function execMany(t,n,r,i,o){var s=[],a=0;if(n.length){var c=(p,l)=>{p?r(p):(s.push(l),++a<n.length?t(n[a],i,o,c):r(void 0,s))};t(n[a],i,o,c)}else r(void 0,[])}function asyncDone(t){return new Promise(((n,r)=>{t(((t,i)=>{t?r(t):n({result:i})}))}))}function syncDone(t){var n,r;if(t(((t,i)=>{r=t,n=i})),r)throw r;return{result:n}}function execAsync(t,n,r,i){return _execAsync.apply(this,arguments)}function _execAsync(){return(_execAsync=_asyncToGenerator((function*(t,n,r,i){var o;try{if(t instanceof Prop)o=t.context[t.prop];else if(Array.isArray(t)){var s=[],a=function*(t){var i=(yield asyncDone((i=>execAsync(t,n,r,i)))).result;if(i instanceof ExecReturn){if(s.push(i.result),i.returned||i.breakLoop||i.continueLoop)return s=i,"break"}else s.push(i)};for(var c of t)if("break"===(yield*a(c)))break;o=s}else if(t instanceof Lisp)if(["arrowFunc","function","inlineFunction","loop","try","switch","if"].includes(t.op))o=(yield asyncDone((i=>ops.get(t.op)(execAsync,i,t.a,t.b,void 0,r,n)))).result;else if("await"===t.op)o=yield(yield asyncDone((i=>execAsync(t.a,n,r,i)))).result;else{var p=(yield asyncDone((i=>execAsync(t.a,n,r,i)))).result,l=p instanceof Prop?p.context?p.context[p.prop]:void 0:p,f=(yield asyncDone((i=>execAsync(t.b,n,r,i)))).result,u=f instanceof Prop?f.context?f.context[f.prop]:void 0:f;if(!ops.has(t.op))throw new SyntaxError("Unknown operator: "+t.op);o=(yield asyncDone((i=>ops.get(t.op)(execAsync,i,l,u,p,r,n,f)))).result}else o=t;i(void 0,o)}catch(t){i(t)}}))).apply(this,arguments)}function syncDoneExec(t,n,r){var i,o;if(execSync(t,n,r,((t,n)=>{o=t,i=n})),o)throw o;return{result:i}}function syncDoneOp(t,n,r,i,o,s,a){var c,p;if(ops.get(t)(execSync,((t,n)=>{p=t,c=n}),n,r,i,o,s,a),p)throw p;return{result:c}}function execSync(t,n,r,i){var o;if(t instanceof Prop)o=t.context[t.prop];else if(Array.isArray(t)){var s=[];for(var a of t){var c=syncDoneExec(a,n,r).result;if(c instanceof ExecReturn){if(s.push(c.result),c.returned||c.breakLoop||c.continueLoop){s=c;break}}else s.push(c)}o=s}else if(t instanceof Lisp)if(["arrowFunc","function","inlineFunction","loop","try","switch","if"].includes(t.op))o=syncDoneOp(t.op,t.a,t.b,void 0,r,n).result;else{if("await"===t.op)throw new SandboxError("Illegal use of 'await', must be inside async function");var p=syncDoneExec(t.a,n,r).result,l=p instanceof Prop?p.context?p.context[p.prop]:void 0:p,f=syncDoneExec(t.b,n,r).result,u=f instanceof Prop?f.context?f.context[f.prop]:void 0:f;if(!ops.has(t.op))throw new SyntaxError("Unknown operator: "+t.op);o=syncDoneOp(t.op,l,u,p,r,n,f).result}else o=t;i(void 0,o)}function executeTree(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0;return syncDone((o=>executeTreeWithDone(execSync,o,t,n,r,i))).result}function executeTreeAsync(t,n){return _executeTreeAsync.apply(this,arguments)}function _executeTreeAsync(){return(_executeTreeAsync=_asyncToGenerator((function*(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0;return(yield asyncDone((o=>executeTreeWithDone(execAsync,o,t,n,r,i)))).result}))).apply(this,arguments)}function executeTreeWithDone(t,n,r,i){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],s=arguments.length>5?arguments[5]:void 0;if(i){if(!(i instanceof Array))throw new SyntaxError("Bad execution tree");for(var a,c=(r={ctx:r.ctx,constants:r.constants,inLoopOrSwitch:s}).ctx.globalScope;a=o.shift();)"object"==typeof a&&(c=a instanceof Scope?a:new Scope(c,a,null));r.ctx.options.audit&&!r.ctx.auditReport&&(r.ctx.auditReport={globalsAccess:new Set,prototypeAccess:{}});var p=0,l=i[p],f=(o,s)=>{if(o)n(new o.constructor(o.message));else if(s instanceof ExecReturn)n(void 0,s);else if(l instanceof Lisp&&"return"===l.op)n(void 0,new ExecReturn(r.ctx.auditReport,s,!0));else if(++p<i.length){l=i[p];try{t(l,c,r,f)}catch(t){n(t)}}else n(void 0,new ExecReturn(r.ctx.auditReport,void 0,!1))};try{t(l,c,r,f)}catch(t){n(t)}}else n()}class SandboxGlobal{constructor(t){if(t===globalThis)return globalThis;for(var n in t)this[n]=t[n]}}class Sandbox{constructor(){var globals=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Sandbox.SAFE_GLOBALS,prototypeWhitelist=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Sandbox.SAFE_PROTOTYPES,prototypeReplacements=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Map,options=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{audit:!1},sandboxGlobal=new SandboxGlobal(globals);this.context={sandbox:this,globals:globals,prototypeWhitelist:prototypeWhitelist,prototypeReplacements:prototypeReplacements,globalsWhitelist:new Set(Object.values(globals)),options:options,globalScope:new Scope(null,globals,sandboxGlobal),sandboxGlobal:sandboxGlobal,evals:new Map,getSubscriptions:new Set,setSubscriptions:new WeakMap,changeSubscriptions:new WeakMap};var func=sandboxFunction(this.context);this.context.evals.set(Function,func),this.context.evals.set(eval,sandboxedEval(func)),this.context.evals.set(setTimeout,sandboxedSetTimeout(func)),this.context.evals.set(setInterval,sandboxedSetInterval(func))}static get SAFE_GLOBALS(){return{Function:Function,console:{debug:console.debug,error:console.error,info:console.info,log:console.log,table:console.table,warn:console.warn},isFinite:isFinite,isNaN:isNaN,parseFloat:parseFloat,parseInt:parseInt,decodeURI:decodeURI,decodeURIComponent:decodeURIComponent,encodeURI:encodeURI,encodeURIComponent:encodeURIComponent,escape:escape,unescape:unescape,Boolean:Boolean,Number:Number,String:String,Object:Object,Array:Array,Symbol:Symbol,Error:Error,EvalError:EvalError,RangeError:RangeError,ReferenceError:ReferenceError,SyntaxError:SyntaxError,TypeError:TypeError,URIError:URIError,Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array,Map:Map,Set:Set,WeakMap:WeakMap,WeakSet:WeakSet,Promise:Promise,Intl:Intl,JSON:JSON,Math:Math,Date:Date}}static get SAFE_PROTOTYPES(){var t=[SandboxGlobal,Function,Boolean,Number,String,Date,Error,Array,Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Map,Set,WeakMap,WeakSet,Promise,Symbol,Date],n=new Map;return t.forEach((t=>{n.set(t,new Set)})),n.set(Object,new Set(["entries","fromEntries","getOwnPropertyNames","is","keys","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf","values"])),n}subscribeGet(t){return this.context.getSubscriptions.add(t),{unsubscribe:()=>this.context.getSubscriptions.delete(t)}}subscribeSet(t,n,r){var i=this.context.setSubscriptions.get(t)||new Map;this.context.setSubscriptions.set(t,i);var o,s=i.get(n)||new Set;return i.set(n,s),s.add(r),t&&t[n]&&"object"==typeof t[n]&&((o=this.context.changeSubscriptions.get(t[n])||new Set).add(r),this.context.changeSubscriptions.set(t[n],o)),{unsubscribe:()=>{s.delete(r),o&&o.delete(r)}}}static audit(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new Sandbox(globalThis,new Map,new Map,{audit:!0}).executeTree(parse(t),n)}static parse(t){return parse(t)}executeTree(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return executeTree({ctx:this.context,constants:t.constants},t.tree,n)}executeTreeAsync(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return executeTreeAsync({ctx:this.context,constants:t.constants},t.tree,n)}compile(t){var n=this,r=parse(t);return function(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];return n.executeTree(r,i).result}}compileAsync(t){var n=this,r=parse(t);return _asyncToGenerator((function*(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];return(yield n.executeTreeAsync(r,i)).result}))}}exports.SandboxGlobal=SandboxGlobal,exports.default=Sandbox;
//# sourceMappingURL=Sandbox.min.js.map
