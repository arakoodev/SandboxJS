{"version":3,"file":"Sandbox.js","sources":["../src/eval.ts","../src/Sandbox.ts"],"sourcesContent":["import { createFunction, currentTicks } from \"./executor.js\";\nimport parse, { lispifyFunction } from \"./parser.js\";\nimport { IExecContext, Ticks } from \"./utils.js\";\n\nexport interface IEvalContext {\n  sandboxFunction: typeof sandboxFunction\n  sandboxedEval: typeof sandboxedEval\n  sandboxedSetTimeout: typeof sandboxedSetTimeout\n  sandboxedSetInterval: typeof sandboxedSetInterval,\n  lispifyFunction: typeof lispifyFunction\n}\nexport type SandboxFunction = (code: string, ...args: string[]) => () => unknown;\nexport type SandboxEval = (code: string) => unknown;\nexport type SandboxSetTimeout = (handler: TimerHandler, timeout?: number, ...args: unknown[]) => any;\nexport type SandboxSetInterval = (handler: TimerHandler, timeout?: number, ...args: unknown[]) => any;\n\nexport function createEvalContext(): IEvalContext {\n  return {\n    sandboxFunction,\n    sandboxedEval,\n    sandboxedSetTimeout,\n    sandboxedSetInterval,\n    lispifyFunction\n  }\n}\n\nexport function sandboxFunction(context: IExecContext, ticks?: Ticks): SandboxFunction {\n  return SandboxFunction;\n  function SandboxFunction(...params: string[]) {\n    let code = params.pop() || \"\";\n    let parsed = parse(code);\n    return createFunction(params, parsed.tree, ticks || currentTicks.current, {\n      ...context,\n      constants: parsed.constants,\n      tree: parsed.tree\n    }, undefined, 'anonymous');\n  }\n}\n\nexport function sandboxedEval(func: SandboxFunction): SandboxEval {\n  return sandboxEval;\n  function sandboxEval(code: string) {\n    return func(code)();\n  }\n}\n\nexport function sandboxedSetTimeout(func: SandboxFunction): SandboxSetTimeout {\n  return function sandboxSetTimeout(handler, ...args) {\n    if (typeof handler !== 'string') return setTimeout(handler, ...args);\n    return setTimeout(func(handler), ...args);\n  }\n}\n\nexport function sandboxedSetInterval(func: SandboxFunction): SandboxSetInterval {\n  return function sandboxSetInterval(handler, ...args) {\n    if (typeof handler !== 'string') return setInterval(handler, ...args);\n    return setInterval(func(handler), ...args);\n  }\n}","import { createExecContext, IExecContext, IOptionParams, IScope } from \"./utils.js\";\nimport { createEvalContext } from \"./eval.js\";\nimport { ExecReturn } from \"./executor.js\";\nimport parse from \"./parser.js\";\nimport SandboxExec from \"./SandboxExec.js\";\n\nexport default class Sandbox extends SandboxExec {\n  constructor(options?: IOptionParams) {\n    super(options, createEvalContext());\n  }\n\n  static audit<T>(code: string, scopes: (IScope)[] = []): ExecReturn<T> {\n    const globals: Record<string, unknown> = {};\n    for (let i of Object.getOwnPropertyNames(globalThis) as [keyof typeof globalThis]) {\n      globals[i] = globalThis[i];\n    }\n    const sandbox = new SandboxExec({\n      globals,\n      audit: true,\n    });\n    return sandbox.executeTree(createExecContext(sandbox, parse(code, true), createEvalContext()), scopes);\n  }\n\n  static parse(code: string) {\n    return parse(code);\n  }\n  \n  compile<T>(code: string, optimize = false): (...scopes: (IScope)[]) => {context: IExecContext, run: () => T} {\n    const parsed = parse(code, optimize);\n    const exec = (...scopes: (IScope)[]) => {\n      const context = createExecContext(this, parsed, this.evalContext);\n      return {context , run: () => this.executeTree<T>(context, [...scopes]).result};\n    };\n    return exec;\n  };\n  \n  compileAsync<T>(code: string, optimize = false): (...scopes: (IScope)[]) => {context: IExecContext, run: () => Promise<T>} {\n    const parsed = parse(code, optimize);\n    const exec = (...scopes: (IScope)[]) => {\n      const context = createExecContext(this, parsed, this.evalContext);\n      return {context , run: () => this.executeTreeAsync<T>(context, [...scopes]).then((ret) => ret.result)};\n    };\n    return exec;\n  };\n\n  compileExpression<T>(code: string, optimize = false): (...scopes: (IScope)[]) => {context: IExecContext, run: () => T} {\n    const parsed = parse(code, optimize, true);\n    const exec = (...scopes: (IScope)[]) => {\n      const context = createExecContext(this, parsed, this.evalContext);\n      return {context , run: () => this.executeTree<T>(context, [...scopes]).result};\n    };\n    return exec\n  }\n\n  compileExpressionAsync<T>(code: string, optimize = false): (...scopes: (IScope)[]) => {context: IExecContext, run: () => Promise<T>} {\n    const parsed = parse(code, optimize, true);\n    const exec = (...scopes: (IScope)[]) => {\n      const context = createExecContext(this, parsed, this.evalContext);\n      return {context , run: () => this.executeTreeAsync<T>(context, [...scopes]).then((ret) => ret.result)};\n    };\n    return exec;\n  }\n}"],"names":[],"mappings":"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"}