"use strict";function asyncGeneratorStep(e,t,n,r,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var o=e.apply(t,n);function s(e){asyncGeneratorStep(o,r,i,s,a,"next",e)}function a(e){asyncGeneratorStep(o,r,i,s,a,"throw",e)}s(void 0)}))}}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function parseHexToInt(e){return!e.match(/[^a-f0-9]/i)?parseInt(e,16):NaN}function validateAndParseHex(e,t,n){var r=parseHexToInt(e);if(Number.isNaN(r)||void 0!==n&&n!==e.length)throw new SyntaxError(t+": "+e);return r}function parseHexadecimalCode(e){var t=validateAndParseHex(e,"Malformed Hexadecimal",2);return String.fromCharCode(t)}function parseUnicodeCode(e,t){var n=validateAndParseHex(e,"Malformed Unicode",4);if(void 0!==t){var r=validateAndParseHex(t,"Malformed Unicode",4);return String.fromCharCode(n,r)}return String.fromCharCode(n)}function isCurlyBraced(e){return"{"===e.charAt(0)&&"}"===e.charAt(e.length-1)}function parseUnicodeCodePointCode(e){if(!isCurlyBraced(e))throw new SyntaxError("Malformed Unicode: +"+e);var t=validateAndParseHex(e.slice(1,-1),"Malformed Unicode");try{return String.fromCodePoint(t)}catch(e){throw e instanceof RangeError?new SyntaxError("Code Point Limit:"+t):e}}Object.defineProperty(exports,"__esModule",{value:!0});var singleCharacterEscapes=new Map([["b","\b"],["f","\f"],["n","\n"],["r","\r"],["t","\t"],["v","\v"],["0","\0"]]);function parseSingleCharacterCode(e){return singleCharacterEscapes.get(e)||e}var escapeMatch=/\\(?:(\\)|x([\s\S]{0,2})|u(\{[^}]*\}?)|u([\s\S]{4})\\u([^{][\s\S]{0,3})|u([\s\S]{0,4})|([0-3]?[0-7]{1,2})|([\s\S])|$)/g;function unraw(e){return e.replace(escapeMatch,(function(e,t,n,r,i,o,s,a,c){if(void 0!==t)return"\\";if(void 0!==n)return parseHexadecimalCode(n);if(void 0!==r)return parseUnicodeCodePointCode(r);if(void 0!==i)return parseUnicodeCode(i,o);if(void 0!==s)return parseUnicodeCode(s);if("0"===a)return"\0";if(void 0!==a)throw new SyntaxError("Octal Deprecation: "+a);if(void 0!==c)return parseSingleCharacterCode(c);throw new SyntaxError("End of string")}))}var lispTypes=new Map;class ParseError extends Error{constructor(e,t){super(e),this.code=t}}class Lisp{constructor(e){this.op=e.op,this.a=e.a,this.b=e.b}}class If{constructor(e,t){this.t=e,this.f=t}}class KeyVal{constructor(e,t){this.key=e,this.val=t}}class SpreadObject{constructor(e){this.item=e}}class SpreadArray{constructor(e){this.item=e}}var inlineIfElse=/^:/,space=/^\s/,expectTypes={splitter:{types:{split:/^(&&|&(?!&)|\|\||\|(?!\|)|<=|>=|<(?!<)|>(?!>)|!==|!=(?!\=)|===|==(?!\=)|\+(?!\+)|\-(?!\-)|\^|<<|>>(?!>)|>>>|instanceof(?![\w\$\_])|in(?![\w\$\_]))(?!\=)/,op:/^(\/|\*\*|\*(?!\*)|\%)(?!\=)/},next:["modifier","value","prop","incrementerBefore"]},inlineIf:{types:{inlineIf:/^\?/},next:["expEnd"]},assignment:{types:{assignModify:/^(\-=|\+=|\/=|\*\*=|\*=|%=|\^=|\&=|\|=|>>>=|>>=|<<=)/,assign:/^(=)(?!=)/},next:["modifier","value","prop","incrementerBefore"]},incrementerBefore:{types:{incrementerBefore:/^(\+\+|\-\-)/},next:["prop"]},expEdge:{types:{call:/^[\(]/,incrementerAfter:/^(\+\+|\-\-)/},next:["splitter","expEdge","inlineIf","dot","expEnd"]},modifier:{types:{not:/^!/,inverse:/^~/,negative:/^\-(?!\-)/,positive:/^\+(?!\+)/,typeof:/^typeof(?![\w\$\_])/,delete:/^delete(?![\w\$\_])/},next:["modifier","value","prop","incrementerBefore"]},dot:{types:{arrayProp:/^[\[]/,dot:/^\.(?!\.)/},next:["splitter","assignment","expEdge","inlineIf","dot","expEnd"]},prop:{types:{prop:/^[a-zA-Z\$\_][a-zA-Z\d\$\_]*/},next:["splitter","assignment","expEdge","inlineIf","dot","expEnd"]},value:{types:{createObject:/^\{/,createArray:/^\[/,number:/^(0x[\da-f]+|\d+(\.\d+)?(e[\+\-]?\d+)?)/i,string:/^"(\d+)"/,literal:/^`(\d+)`/,regex:/^\/(\d+)\/r(?![\w\$\_])/,boolean:/^(true|false)(?![\w\$\_])/,null:/^null(?![\w\$\_])/,und:/^undefined(?![\w\$\_])/,arrowFunctionSingle:/^(async\s+)?([a-zA-Z\$_][a-zA-Z\d\$_]*)\s*=>\s*({)?/,arrowFunction:/^(async\s*)?\(\s*((\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*(\s*,\s*(\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)*)?\s*\)\s*=>\s*({)?/,inlineFunction:/^(async\s+)?function(\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)?\s*\(\s*((\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*(\s*,\s*(\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)*)?\s*\)\s*{/,group:/^\(/,NaN:/^NaN(?![\w\$\_])/,Infinity:/^Infinity(?![\w\$\_])/,void:/^void(?![\w\$\_])\s*/,await:/^await(?![\w\$\_])\s*/,new:/^new(?![\w\$\_])\s*/,throw:/^throw(?![\w\$\_])\s*/},next:["splitter","expEdge","inlineIf","dot","expEnd"]},initialize:{types:{initialize:/^(var|let|const)\s+([a-zA-Z\$_][a-zA-Z\d\$_]*)\s*(=)?/,return:/^return(?![\w\$\_])/},next:["modifier","value","prop","incrementerBefore","expEnd"]},spreadObject:{types:{spreadObject:/^\.\.\./},next:["value","prop"]},spreadArray:{types:{spreadArray:/^\.\.\./},next:["value","prop"]},expEnd:{types:{},next:[]},expSingle:{types:{for:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*for\s*\(/,do:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*do\s*\{/,while:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*while\s*\(/,loopAction:/^(break|continue)(?![\w\$\_])/,if:/^if\s*\(/,try:/^try\s*{/,function:/^(async\s+)?function(\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)\s*\(\s*((\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*(\s*,\s*(\.\.\.)?\s*[a-zA-Z\$_][a-zA-Z\d\$_]*)*)?\s*\)\s*{/,switch:/^(([a-zA-Z\$\_][\w\$\_]*)\s*:)?\s*switch\s*\(/},next:["expEnd"]}},closings={"(":")","[":"]","{":"}","'":"'",'"':'"',"`":"`"},okFirstChars=/^[\+\-~ !]/,aChar=/^[\w\$]/,aNumber=expectTypes.value.types.number;function restOfExp(e,t,n,r,i,o){var s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},a=arguments.length>7?arguments[7]:void 0,c=!0;n=n||[];var p,l=!1,f=!1,u=!1,d=!1,h="",y="";for(p=0;p<t.length&&!f;p++){var g=t[p];if(u=d,(d=aChar.test(g))||space.test(g)||closings[g]||(y=""),d&&o&&(y+=g),'"'===r||"'"===r||"`"===r){if("`"!==r||"$"!==g||"{"!==t[p+1]||l){if(g===r&&!l)return t.substring(0,p)}else{var v=restOfExp(e,t.substring(p+2),[],"{");p+=v.length+2}l=!l&&"\\"===g}else if(closings[g]){if(g===i){f=!0;break}var x=restOfExp(e,t.substring(p+1),[],g);if(p+=x.length+1,c=!1,o){var b=t.substring(p);for(var w of o){w.lastIndex=0;var S=w.exec(b);if(S&&(p+=S[1].length-1,s.word=y,f=!0))break}}}else if(r){if(g===closings[r])return t.substring(0,p)}else{var E=t.substring(p),m=void 0;if((m=aNumber.exec(E))&&(p+=m[0].length-1,E=t.substring(p)),a||(!u||!d)&&h!==g)for(var T of n){var A=T.exec(E);if(A){o&&(p+=A[1].length),f=!0;break}}if(c&&(okFirstChars.test(E)?f=!1:c=!1),f)break}h=g}if(r)throw new SyntaxError("Unclosed '"+r+"': "+r+t.substring(0,Math.min(p,40)));return t.substring(0,p)}restOfExp.next=["splitter","expEnd","inlineIf"];var setLispType=(e,t)=>{e.forEach((e=>{lispTypes.set(e,t)}))},closingsCreate={createArray:/^\]/,createObject:/^\}/,group:/^\)/,arrayProp:/^\]/,call:/^\)/};setLispType(["createArray","createObject","group","arrayProp","call"],((e,t,n,r,i,o)=>{for(var s="",a=[],c=!1,p=1;p<n.length&&!c;)p+=(s=restOfExp(e,n.substring(p),[closingsCreate[t],/^,/])).length,s&&a.push(s),","!==n[p]?c=!0:p++;var l,f,u=["value","modifier","prop","incrementerBefore","expEnd"];switch(t){case"group":case"arrayProp":l=lispifyExpr(e,a.join(","));break;case"call":case"createArray":l=a.map((t=>lispify(e,t,[...u,"spreadArray"])));break;case"createObject":l=a.map((t=>{var n,r;if(t=t.trimStart(),f=expectTypes.expSingle.types.function.exec("function "+t))r=f[2].trimStart(),n=lispify(e,"function "+t.replace(r,""));else{var i=restOfExp(e,t,[/^:/]);if((r=lispify(e,i,[...u,"spreadObject"]))instanceof Lisp&&"prop"===r.op&&(r=r.b),i.length===t.length)return r;n=lispify(e,t.substring(i.length+1))}return new Lisp({op:"keyVal",a:r,b:n})}))}t="arrayProp"===t?"prop":t,o.lispTree=lispify(e,n.substring(p+1),expectTypes[i].next,new Lisp({op:t,a:o.lispTree,b:l}))})),setLispType(["inverse","not","negative","positive","typeof","delete","op"],((e,t,n,r,i,o)=>{var s=restOfExp(e,n.substring(r[0].length),[/^[^\s\.\w\d\$]/]);o.lispTree=lispify(e,n.substring(s.length+r[0].length),restOfExp.next,new Lisp({op:["positive","negative"].includes(t)?"$"+r[0]:r[0],a:o.lispTree,b:lispify(e,s,expectTypes[i].next)}))})),setLispType(["incrementerBefore"],((e,t,n,r,i,o)=>{var s=restOfExp(e,n.substring(2),[/^[^\s\.\w\d\$]/]);o.lispTree=lispify(e,n.substring(s.length+2),restOfExp.next,new Lisp({op:r[0]+"$",a:lispify(e,s,expectTypes[i].next)}))})),setLispType(["incrementerAfter"],((e,t,n,r,i,o)=>{o.lispTree=lispify(e,n.substring(r[0].length),expectTypes[i].next,new Lisp({op:"$"+r[0],a:o.lispTree}))})),setLispType(["assign","assignModify"],((e,t,n,r,i,o)=>{o.lispTree=new Lisp({op:r[0],a:o.lispTree,b:lispify(e,n.substring(r[0].length),expectTypes[i].next)})})),setLispType(["split"],((e,t,n,r,i,o)=>{var s=restOfExp(e,n.substring(r[0].length),[expectTypes.splitter.types.split,expectTypes.inlineIf.types.inlineIf,inlineIfElse]);o.lispTree=lispify(e,n.substring(s.length+r[0].length).trim(),restOfExp.next,new Lisp({op:r[0].trim(),a:o.lispTree,b:lispify(e,s,expectTypes[i].next)}))})),setLispType(["inlineIf"],((e,t,n,r,i,o)=>{for(var s=!1,a="",c=1;!s&&a.length<n.length;)a+=restOfExp(e,n.substring(a.length+1),[expectTypes.inlineIf.types.inlineIf,inlineIfElse]),"?"===n[a.length+1]?c++:c--,c?a+=n[a.length+1]:s=!0;o.lispTree=new Lisp({op:"?",a:o.lispTree,b:new Lisp({op:":",a:lispifyExpr(e,a),b:lispifyExpr(e,n.substring(r[0].length+a.length+1))})})})),setLispType(["if"],((e,t,n,r,i,o)=>{var s=restOfExp(e,n.substring(r[0].length),[],"("),a=/^\s*\{/.exec(n.substring(r[0].length+s.length+1)),c=r[0].length+s.length+1+(a?a[0].length:0),p=restOfExp(e,n.substring(c),a?[/^\}/]:[/^else(?!\w\$)/]),l="";if(c+p.length+(a?a[0].length:0)<n.length){var f=n.substring(c+p.length+(a?a[0].length:0)),u=/\s*else(?!\w\$\s)\s*/.exec(f);u&&(l=f.substring(u[0].length))}s=s.trim(),p=p.trim(),l=l.trim(),"{"===p[0]&&(p=p.slice(1,-1)),"{"===l[0]&&(l=l.slice(1,-1)),o.lispTree=new Lisp({op:"if",a:lispifyExpr(e,s),b:new If(lispifyBlock(p,e),l?lispifyBlock(l,e):void 0)})})),setLispType(["switch"],((e,t,n,r,i,o)=>{var s=restOfExp(e,n.substring(r[0].length),[],"("),a=n.indexOf("{",r[0].length+s.length+1);if(-1===a)throw new SyntaxError("Invalid switch: "+n);for(var c,p=insertSemicolons(e,restOfExp(e,n.substring(a+1),[],"{"),!1),l=/^\s*(case\s|default)\s*/,f=[],u=!1;c=l.exec(p);){if("default"===c[1]){if(u)throw new SyntaxError("Only one default switch case allowed:"+p);u=!0}var d=restOfExp(e,p.substring(c[0].length),[/^:/]),h="",y=a=c[0].length+d.length+1,g=/^\s*\{/.exec(p.substring(y)),v=[];if(g)y+=g[0].length,y+=(h=restOfExp(e,p.substring(y),[],"{")).length+1,v=lispifyBlock(h,e);else{var x=restOfExp(e,p.substring(y),[l]);if(x.trim()){for(var b=[];(h=restOfExp(e,p.substring(y),[/^;/]))&&(b.push(h),y+=h.length+1,!l.test(p.substring(y))););v=lispifyBlock(b.join(";"),e)}else v=void 0,y+=x.length}p=p.substring(y),f.push(new Lisp({op:"case",a:"default"===c[1]?void 0:lispifyExpr(e,d),b:v}))}o.lispTree=new Lisp({op:"switch",a:lispifyExpr(e,s),b:f})})),setLispType(["dot","prop"],((e,t,n,r,i,o)=>{var s=r[0],a=r[0].length;if("."===r[0]){var c=n.substring(r[0].length).match(expectTypes.prop.types.prop);if(!c||!c.length)throw new SyntaxError("Hanging  dot:"+n);a=(s=c[0]).length+r[0].length}o.lispTree=lispify(e,n.substring(a),expectTypes[i].next,new Lisp({op:"prop",a:o.lispTree,b:s}))})),setLispType(["spreadArray","spreadObject"],((e,t,n,r,i,o)=>{o.lispTree=new Lisp({op:t,b:lispify(e,n.substring(r[0].length),expectTypes[i].next)})})),setLispType(["return"],((e,t,n,r,i,o)=>{o.lispTree=new Lisp({op:t,b:lispifyExpr(e,n.substring(r[0].length))})}));var primitives={true:!0,false:!1,null:null,Infinity:1/0,NaN:NaN,und:void 0};setLispType(["number","boolean","null","und","NaN","Infinity"],((e,t,n,r,i,o)=>{o.lispTree=lispify(e,n.substring(r[0].length),expectTypes[i].next,"number"===t?Number(r[0]):primitives["boolean"===t?r[0]:t])})),setLispType(["string","literal","regex"],((e,t,n,r,i,o)=>{o.lispTree=lispify(e,n.substring(r[0].length),expectTypes[i].next,new Lisp({op:t,b:parseInt(JSON.parse(r[1]),10)}))})),setLispType(["initialize"],((e,t,n,r,i,o)=>{r[3]?o.lispTree=new Lisp({op:r[1],a:r[2],b:lispify(e,n.substring(r[0].length),expectTypes[i].next)}):o.lispTree=lispify(e,n.substring(r[0].length),expectTypes[i].next,new Lisp({op:r[1],a:r[2]}))})),setLispType(["function","inlineFunction","arrowFunction","arrowFunctionSingle"],((e,t,n,r,i,o)=>{var s="function"!==t&&"inlineFunction"!==t,a=s&&!r[r.length-1],c=s?2:3,p=!!r[1],l=r[c]?r[c].replace(/\s+/g,"").split(/,/g):[];s||l.unshift((r[2]||"").trimStart());var f=!1;l.forEach((e=>{if(f)throw new SyntaxError("Rest parameter must be last formal parameter");e.startsWith("...")&&(f=!0)})),l.unshift(p);var u=(a?"return ":"")+restOfExp(e,n.substring(r[0].length),a?[/^[,;\)\}\]]/]:[/^}/]);o.lispTree=lispify(e,n.substring(r[0].length+u.length+1),expectTypes[i].next,new Lisp({op:s?"arrowFunc":t,a:l,b:lispifyFunction(u,e)}))}));var iteratorRegex=/^((let|var|const)\s+)?\s*([a-zA-Z\$_][a-zA-Z\d\$_]*)\s+(in|of)\s+/;setLispType(["for","do","while"],((e,t,n,r,i,o)=>{var s,a,c=n.indexOf("(")+1,p=!0,l=[],f=!1,u=!0,d=!0;switch(t){case"while":var h=restOfExp(e,n.substring(c),[],"(");s=lispifyExpr(e,h),"{"===(a=restOfExp(e,n.substring(c+h.length+1)).trim())[0]&&(a=a.slice(1,-1));break;case"for":for(var y,g=[],v="",x=0;x<3&&(v=restOfExp(e,n.substring(c),[/^[;\)]/]),g.push(v.trim()),")"!==n[(c+=v.length+1)-1]);x++);if(1===g.length&&(y=iteratorRegex.exec(g[0])))"of"===y[4]?(l=[lispify(e,"let $$obj = "+g[0].substring(y[0].length),["initialize"]),ofStart2,ofStart3],s=ofCondition,d=ofStep,f=lispify(e,(y[1]||"let ")+y[3]+" = $$next.value",["initialize"])):(l=[lispify(e,"let $$obj = "+g[0].substring(y[0].length),["initialize"]),inStart2,inStart3],d=inStep,s=inCondition,f=lispify(e,(y[1]||"let ")+y[3]+" = $$keys[$$keyIndex]",["initialize"]));else{if(3!==g.length)throw new SyntaxError("Invalid for loop definition");p=lispifyExpr(e,g.shift(),startingExecpted),s=lispifyExpr(e,g.shift()),d=lispifyExpr(e,g.shift())}"{"===(a=restOfExp(e,n.substring(c)).trim())[0]&&(a=a.slice(1,-1));break;case"do":u=!1;var b=n.indexOf("{")+1;a=restOfExp(e,n.substring(b),[],"{"),s=lispifyExpr(e,restOfExp(e,n.substring(n.indexOf("(",b+a.length)+1),[],"("))}o.lispTree=new Lisp({op:"loop",a:[u,l,p,d,s,f],b:lispifyBlock(a,e)})})),setLispType(["block"],((e,t,n,r,i,o)=>{o.lispTree=lispifyBlock(restOfExp(e,n.substring(1),[],"{"),e)})),setLispType(["loopAction"],((e,t,n,r,i,o)=>{o.lispTree=new Lisp({op:"loopAction",a:r[1]})}));var catchReg=/^\s*(catch\s*(\(\s*([a-zA-Z\$_][a-zA-Z\d\$_]*)\s*\))?|finally)\s*\{/;setLispType(["try"],((e,t,n,r,i,o)=>{var s,a,c,p=restOfExp(e,n.substring(r[0].length),[],"{"),l=catchReg.exec(n.substring(r[0].length+p.length+1)),f=0;l[1].startsWith("catch")?(a=(l=catchReg.exec(n.substring(r[0].length+p.length+1)))[2],c=restOfExp(e,n.substring(r[0].length+p.length+1+l[0].length),[],"{"),f=r[0].length+p.length+1+l[0].length+c.length+1,(l=catchReg.exec(n.substring(f)))&&l[1].startsWith("finally")&&(s=restOfExp(e,n.substring(f+l[0].length),[],"{"))):s=restOfExp(e,n.substring(r[0].length+p.length+1+l[0].length),[],"{"),o.lispTree=new Lisp({op:"try",a:lispifyBlock(insertSemicolons(e,p,!1),e),b:[a,lispifyBlock(insertSemicolons(e,c||"",!1),e),lispifyBlock(insertSemicolons(e,s||"",!1),e)]})})),setLispType(["void","await","throw"],((e,t,n,r,i,o)=>{var s=restOfExp(e,n.substring(r[0].length),[/^[^\s\.\w\d\$]/]);o.lispTree=lispify(e,n.substring(r[0].length+s.length),expectTypes[i].next,new Lisp({op:t,a:lispify(e,s)}))})),setLispType(["new"],((e,t,n,r,i,o)=>{var s=r[0].length,a=restOfExp(e,n.substring(s),[],void 0,"("),c=[];if("("===n[(s+=a.length+1)-1]){var p,l=restOfExp(e,n.substring(s),[],"(");s+=l.length+1;for(var f=0;p=restOfExp(e,l.substring(f),[/^,/]);)f+=p.length+1,c.push(p.trim())}o.lispTree=lispify(e,n.substring(s),expectTypes.expEdge.next,new Lisp({op:t,a:lispify(e,a,expectTypes.initialize.next),b:c.map((t=>lispify(e,t,expectTypes.initialize.next)))}))}));var ofStart2=lispify(void 0,"let $$iterator = $$obj[Symbol.iterator]()",["initialize"]),ofStart3=lispify(void 0,"let $$next = $$iterator.next()",["initialize"]),ofCondition=lispify(void 0,"return !$$next.done",["initialize"]),ofStep=lispify(void 0,"$$next = $$iterator.next()"),inStart2=lispify(void 0,"let $$keys = Object.keys($$obj)",["initialize"]),inStart3=lispify(void 0,"let $$keyIndex = 0",["initialize"]),inStep=lispify(void 0,"$$keyIndex++"),inCondition=lispify(void 0,"return $$keyIndex < $$keys.length",["initialize"]),startingExecpted=["initialize","expSingle","value","modifier","prop","incrementerBefore","expEnd"],lastType,lastPart;function lispify(e,t,n,r){if(n=n||expectTypes.initialize.next,void 0===t)return r;if(!(t=t.trimStart()).length&&!n.includes("expEnd"))throw new SyntaxError("Unexpected end of expression: "+lastPart);if(!t)return r;var i,o={lispTree:r};for(var s of n)if("expEnd"!==s){for(var a in expectTypes[s].types)if("expEnd"!==a&&(i=expectTypes[s].types[a].exec(t))){lastType=a,lastPart=t,lispTypes.get(a)(e,a,t,i,s,o);break}if(i)break}if(!i&&t.length)throw SyntaxError("Unexpected token (".concat(lastType,"): ").concat(t.substring(0,40)));return o.lispTree}function lispifyExpr(e,t,n){if(t.trim()){var r,i=[],o=0;for(n=n||expectTypes.initialize.next;r=restOfExp(e,t.substring(o),[/^,/]);)i.push(r.trimStart()),o+=r.length+1;if(1===i.length)return lispify(e,t,n);if(n===startingExecpted){var s=expectTypes.initialize.types.initialize.exec(i[0]);if(s)return i.map(((t,n)=>lispify(e,n?s[1]+" "+t:t,["initialize"])));if(expectTypes.initialize.types.return.exec(i[0]))return lispify(e,t,n)}var a=i.map(((t,r)=>lispify(e,t,n)));return new Lisp({op:"multi",a:a})}}function lispifyBlock(e,t){if(!(e=insertSemicolons(t,e,!1)).trim())return[];for(var n,r=[],i=0;n=restOfExp(t,e.substring(i),[/^;/]);)r.push(n.trim()),i+=n.length+1;return r.filter(Boolean).map(((e,n)=>lispifyExpr(t,e,startingExecpted))).flat()}function lispifyFunction(e,t){if(!e.trim())return[];var n=lispifyBlock(e,t),r=[];return hoist(n,r),r.concat(n)}function hoist(e,t){if(Array.isArray(e)){var n=[];for(var r of e)hoist(r,t)||n.push(r);n.length!==e.length&&(e.length=0,e.push(...n))}else if(e instanceof Lisp)if("try"===e.op||"if"===e.op||"loop"===e.op||"switch"===e.op)hoist(e.a,t),hoist(e.b,t);else if("var"===e.op)t.push(new Lisp({op:"var",a:e.a}));else if("function"===e.op&&e.a[1])return t.push(e),!0;return!1}var edgesForInsertion=[/^([\w\$]|\+\+|\-\-)\s*\r?\n\s*([\w\$\+\-])/,/^([^\w\$](return|continue|break|throw))\s*\r?\n\s*[^\s]/],closingsForInsertion=[/^([\)\]])\s*\r?\n\s*([\w\$\{\+\-])/,/^(\})\s*\r?\n?\s*([\(])/,/^(\})\s*(\r?\n)?\s*([\w\[\+\-])/],closingsNoInsertion=/^(\})\s*(catch|finally|else|while|instanceof)(?![\w\$])/,whileEnding=/^\}\s*while/;function insertSemicolons(e,t,n){for(var r=t,i="",o=[],s={};i=restOfExp(e,r,edgesForInsertion,void 0,void 0,n?void 0:closingsForInsertion,s,!0);)o.push(i),closingsNoInsertion.test(r.substring(i.length-1))?"do"!==s.word&&whileEnding.test(r.substring(i.length-1))&&o.push(";"):o.push(";"),r=r.substring(i.length);return o.pop(),o.join("")}var oneLinerBlocks=/[^\w\$](if|do)(?![\w\$])/g;function convertOneLiners(e,t){for(var n,r=0,i=[];n=oneLinerBlocks.exec(t);){var o=t.substring(n.index+n[0].length),s=n.index+n[0].length;if("if"===n[1]){var a=o.indexOf("(")+1;s+=a;var c=restOfExp(e,o.substring(a),[],"(");oneLinerBlocks.lastIndex=n.index+a+c.length+1,i.push(t.substring(r,s),[c],")"),s+=c.length+1}else i.push(t.substring(r,s));if(s+=/^\s*/.exec(t.substring(s))[0].length,"{"!==(o=t.substring(s))[0]){var p=restOfExp(e,o,[/^([;\)\]\}]|\r?\n)/]),l=0;";"===o[p.length]&&(l=1),i.push("{",p,"}");var f=o.substring(p.length+l);"if"!==n[1]||/^\s*else(?![\w\$])/.test(f)||i.push(";"),r=s+p.length+l}else r=s}for(var u of(i.push(t.substring(r)),i))if(u instanceof Array){var d=convertOneLiners(e,u[0]);u.length=0,u.push(d)}return i.flat().join("")}function checkRegex(e){for(var t=1,n=!1,r=!1,i=!1;t<e.length&&!r&&!i;)r="/"===e[t]&&!n,n="\\"===e[t]&&!n,i="\n"===e[t],t++;var o=e.substring(t);if(i=i||!r||/^\s*\d/.test(o))return null;var s=/^[a-z]*/.exec(o);return/^\s+[\w\$]/.test(e.substring(t+s[0].length))?null:{regex:e.substring(1,t-1),flags:s&&s[0]||"",length:t+(s&&s[0].length||0)}}var notDivide=/(typeof|delete|instanceof|return|in|of|throw|new|void|do|if)$/,possibleDivide=/^([\w\$\]\)]|\+\+|\-\-)[^\w\$\]\)\+\-]/;function extractConstants(e,t){for(var n,r,i,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",s=[],a=!1,c="",p=-1,l=[],f="",u=[],d=[],h=0;h<t.length;h++)if(f=t[h],c)f===c&&("*"===c&&"/"===t[h+1]?(c="",h++):"\n"===c&&(c=""));else{if(a){a=!1,s.push(f);continue}if(n)if("`"===n&&"$"===f&&"{"===t[h+1]){var y=extractConstants(e,t.substring(h+2),"{");l.push(y.str),s.push("${".concat(l.length-1,"}")),h+=y.length+2}else n===f?("`"===n?(e.literals.push({op:"literal",a:unraw(s.join("")),b:l}),u.push("`".concat(e.literals.length-1,"`"))):(e.strings.push(unraw(s.join(""))),u.push('"'.concat(e.strings.length-1,'"'))),n=null,s=[]):s.push(f);else{if("'"===f||'"'===f||"`"===f)l=[],n=f;else{if(closings[o]===f&&!d.length)return{str:u.join(""),length:h};closings[f]?(d.push(f),u.push(f)):closings[d[d.length-1]]===f?(d.pop(),u.push(f)):"/"!==f||"*"!==t[h+1]&&"/"!==t[h+1]?"/"===f&&!i&&(r=checkRegex(t.substring(h)))?(e.regexes.push(r),u.push("/".concat(e.regexes.length-1,"/r")),h+=r.length-1):u.push(f):(c="*"===t[h+1]?"*":"\n",p=h)}i&&space.test(f)||(i=possibleDivide.exec(t.substring(h)))&&notDivide.test(t.substring(0,h+i[1].length))&&(i=null)}a=n&&"\\"===f}if(c&&"*"===c)throw new SyntaxError("Unclosed comment '/*': ".concat(t.substring(p)));return{str:u.join(""),length:h}}function parse(e){if("string"!=typeof e)throw new ParseError("Cannot parse ".concat(e),e);var t=" "+e,n={strings:[],literals:[],regexes:[]};t=extractConstants(n,t).str,t=insertSemicolons(n,t,!0),t=convertOneLiners(n,t);try{for(var r of n.literals)r.b=r.b.map((e=>lispifyExpr(n,e)));return{tree:lispifyFunction(t,n),constants:n}}catch(e){throw e}}class ExecReturn{constructor(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.auditReport=e,this.result=t,this.returned=n,this.breakLoop=r,this.continueLoop=i}}class Prop{constructor(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];this.context=e,this.prop=t,this.isConst=n,this.isGlobal=r,this.isVariable=i}}var reservedWords=new Set(["instanceof","typeof","return","try","catch","if","finally","else","in","of","var","let","const","for","delete","false","true","while","do","break","continue","new","function","async","await","switch","case"]),VarType;!function(e){e.let="let",e.const="const",e.var="var"}(VarType||(VarType={}));class Scope{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2?arguments[2]:void 0;this.const=new Set,this.let=new Set;var r=void 0!==n||null===e;this.parent=e,this.allVars=t,this.let=r?this.let:new Set(Object.keys(t)),this.var=r?new Set(Object.keys(t)):this.var,this.globals=null===e?new Set(Object.keys(t)):new Set,this.functionThis=n}get(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if("this"===e&&void 0!==this.functionThis)return new Prop({this:this.functionThis},e,!0,!1,!0);if(reservedWords.has(e))throw new SyntaxError("Unexepected token '"+e+"'");if(null===this.parent||!t||void 0!==this.functionThis){if(this.globals.has(e))return new Prop(this.functionThis,e,!1,!0,!0);if(e in this.allVars&&(!(e in{})||this.allVars.hasOwnProperty(e)))return new Prop(this.allVars,e,this.const.has(e),this.globals.has(e),!0);if(null===this.parent)return new Prop(void 0,e)}return this.parent.get(e,t)}set(e,t){if("this"===e)throw new SyntaxError('"this" cannot be assigned');if(reservedWords.has(e))throw new SyntaxError("Unexepected token '"+e+"'");var n=this.get(e);if(void 0===n.context)throw new ReferenceError("Variable '".concat(e,"' was not declared."));if(n.isConst)throw new TypeError("Cannot assign to const variable '".concat(e,"'"));if(n.isGlobal)throw new SandboxError("Cannot override global variable '".concat(e,"'"));return n.context[n]=t,n}declare(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:void 0,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if("this"===e)throw new SyntaxError('"this" cannot be declared');if(reservedWords.has(e))throw new SyntaxError("Unexepected token '"+e+"'");if("var"===t&&void 0===this.functionThis&&null!==this.parent)return this.parent.declare(e,t,n,r);if((!this[t].has(e)||"const"===t||this.globals.has(e))&&e in this.allVars)throw new SandboxError("Identifier '".concat(e,"' has already been declared"));return r&&this.globals.add(e),this[t].add(e),this.allVars[e]=n,new Prop(this.allVars,e,this.const.has(e),r)}}class SandboxError extends Error{}function sandboxFunction(e){return function SandboxFunction(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=n.pop()||"",o=parse(i);return createFunction(n,o.tree,{ctx:e,constants:o.constants},void 0,"anonymous")}}var sandboxedFunctions=new WeakSet;function createFunction(e,t,n,r,i){var o=function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];var c={};e.forEach(((e,t)=>{e.startsWith("...")?c[e.substring(3)]=s.slice(t):c[e]=s[t]}));var p=executeTree(n,t,void 0===r?[]:[new Scope(r,c,void 0===i?void 0:this)]);return p.result};return sandboxedFunctions.add(o),o}function createFunctionAsync(e,t,n,r,i){var o=function(){var o=_asyncToGenerator((function*(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];var c={};e.forEach(((e,t)=>{e.startsWith("...")?c[e.substring(3)]=s.slice(t):c[e]=s[t]}));var p=yield executeTreeAsync(n,t,void 0===r?[]:[new Scope(r,c,void 0===i?void 0:this)]);return p.result}));return function(){return o.apply(this,arguments)}}();return sandboxedFunctions.add(o),o}function sandboxedEval(e){return function(t){return e(t)()}}function sandboxedSetTimeout(e){return function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return"string"!=typeof t?setTimeout(t,...r):setTimeout(e(t),...r)}}function sandboxedSetInterval(e){return function(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];return"string"!=typeof t?setInterval(t,...r):setInterval(e(t),...r)}}function assignCheck(e,t){var n,r,i,o,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"assign";if(void 0===e.context)throw new ReferenceError("Cannot ".concat(s," value to undefined."));if("object"!=typeof e.context&&"function"!=typeof e.context)throw new SyntaxError("Cannot ".concat(s," value to a primitive."));if(e.isConst)throw new TypeError("Cannot set value to const variable '".concat(e.prop,"'"));if(e.isGlobal)throw new SandboxError("Cannot ".concat(s," property '").concat(e.prop,"' of a global object"));if("function"==typeof e.context[e.prop]&&!e.context.hasOwnProperty(e.prop))throw new SandboxError("Override prototype property '".concat(e.prop,"' not allowed"));"delete"===s?e.context.hasOwnProperty(e.prop)&&(null===(n=t.ctx.changeSubscriptions.get(e.context))||void 0===n||n.forEach((t=>t({type:"delete",prop:e.prop})))):e.context.hasOwnProperty(e.prop)?null===(i=null===(r=t.ctx.setSubscriptions.get(e.context))||void 0===r?void 0:r.get(e.prop))||void 0===i||i.forEach((e=>e({type:"replace"}))):null===(o=t.ctx.changeSubscriptions.get(e.context))||void 0===o||o.forEach((t=>t({type:"create",prop:e.prop})))}var arrayChange=new Set([[].push,[].pop,[].shift,[].unshift,[].splice,[].reverse,[].sort,[].copyWithin]),literalRegex=/(\$\$)*(\$)?\${(\d+)}/g,ops2={prop:(e,t,n,r,i,o,s)=>{if(null===n)throw new TypeError("Cannot get property ".concat(r," of null"));var a=typeof n;if("undefined"===a&&void 0===i){var c=s.get(r);if(void 0===c.context)throw new ReferenceError("".concat(r," is not defined"));if(c.context===o.ctx.sandboxGlobal){o.ctx.options.audit&&o.ctx.auditReport.globalsAccess.add(r);var p=o.ctx.globalsWhitelist.has(o.ctx.sandboxGlobal[r])?o.ctx.evals.get(o.ctx.sandboxGlobal[r]):void 0;if(p)return void t(void 0,p)}return c.context&&c.context[r]===globalThis?void t(void 0,o.ctx.globalScope.get("this")):(o.ctx.getSubscriptions.forEach((e=>e(c.context,c.prop))),void t(void 0,c))}if(void 0===n)throw new SandboxError("Cannot get property '"+r+"' of undefined");if("object"!==a)"number"===a?n=new Number(n):"string"===a?n=new String(n):"boolean"===a&&(n=new Boolean(n));else if(void 0===n.hasOwnProperty)return void t(void 0,new Prop(void 0,r));var l="function"===a,f=l||!(n.hasOwnProperty(r)||"number"==typeof r);if(o.ctx.options.audit&&f&&"string"==typeof r){var u=n.constructor.prototype;do{u.hasOwnProperty(r)&&(o.ctx.auditReport.prototypeAccess[u.constructor.name]||(o.ctx.auditReport.prototypeAccess[u.constructor.name]=new Set),o.ctx.auditReport.prototypeAccess[u.constructor.name].add(r))}while(u=Object.getPrototypeOf(u))}if(f)if(l){if(!["name","length","constructor"].includes(r)&&n.hasOwnProperty(r)){var d=o.ctx.prototypeWhitelist.get(n),h=o.ctx.prototypeReplacements.get(n);if(h)return void t(void 0,new Prop(h(n,!0),r));if(!d||d.size&&!d.has(r))throw new SandboxError("Static method or property access not permitted: ".concat(n.name,".").concat(r))}}else if("constructor"!==r){var y=n.constructor.prototype;do{if(y.hasOwnProperty(r)){var g=o.ctx.prototypeWhitelist.get(y.constructor),v=o.ctx.prototypeReplacements.get(y.constuctor);if(v)return void t(void 0,new Prop(v(n,!1),r));if(g&&(!g.size||g.has(r)))break;throw new SandboxError("Method or property access not permitted: ".concat(y.constructor.name,".").concat(r))}}while(y=Object.getPrototypeOf(y))}var x=o.ctx.globalsWhitelist.has(n[r])?o.ctx.evals.get(n[r]):void 0;if(x)t(void 0,x);else if(n[r]!==globalThis){var b=i.isGlobal||l&&!sandboxedFunctions.has(n)||o.ctx.globalsWhitelist.has(n);b||o.ctx.getSubscriptions.forEach((e=>e(n,r))),t(void 0,new Prop(n,r,!1,b))}else t(void 0,o.ctx.globalScope.get("this"))},call:(e,t,n,r,i,o,s)=>{if(o.ctx.options.forbidMethodCalls)throw new SandboxError("Method calls are not allowed");if("function"!=typeof n)throw new TypeError("".concat(i.prop," is not a function"));execMany(e,r.map((e=>e instanceof SpreadArray?[...e.item]:[e])).flat(),((e,n)=>{var r;if(e)t(e);else if("function"!=typeof i){if(i.context[i.prop]===JSON.stringify&&o.ctx.getSubscriptions.size){var s=new Set,a=e=>{if(e&&"object"==typeof e&&!s.has(e)){s.add(e);var t=function(t){o.ctx.getSubscriptions.forEach((n=>n(e,t))),a(e[t])};for(var n in e)t(n)}};a(n[0])}if(i.context instanceof Array&&arrayChange.has(i.context[i.prop])&&o.ctx.changeSubscriptions.get(i.context)){var c,p=!1;if("push"===i.prop)c={type:"push",added:n},p=!!n.length;else if("pop"===i.prop)p=!!(c={type:"pop",removed:i.context.slice(-1)}).removed.length;else if("shift"===i.prop)p=!!(c={type:"shift",removed:i.context.slice(0,1)}).removed.length;else if("unshift"===i.prop)c={type:"unshift",added:n},p=!!n.length;else if("splice"===i.prop)p=!!(c={type:"splice",startIndex:n[0],deleteCount:void 0===n[1]?i.context.length:n[1],added:n.slice(2),removed:i.context.slice(n[0],void 0===n[1]?void 0:n[0]+n[1])}).added.length||!!c.removed.length;else if("reverse"===i.prop||"sort"===i.prop)c={type:i.prop},p=!!i.context.length;else if("copyWithin"===i.prop){var l=void 0===n[2]?i.context.length-n[1]:Math.min(i.context.length,n[2]-n[1]);p=!!(c={type:"copyWithin",startIndex:n[0],endIndex:n[0]+l,added:i.context.slice(n[1],n[1]+l),removed:i.context.slice(n[0],n[0]+l)}).added.length||!!c.removed.length}p&&(null===(r=o.ctx.changeSubscriptions.get(i.context))||void 0===r||r.forEach((e=>e(c))))}t(void 0,i.context[i.prop](...n))}else t(void 0,i(...n))}),s,o)},createObject:(e,t,n,r,i,o,s)=>{var a={};for(var c of r)c instanceof SpreadObject?a=_objectSpread2(_objectSpread2({},a),c.item):a[c.key]=c.val;t(void 0,a)},keyVal:(e,t,n,r)=>t(void 0,new KeyVal(n,r)),createArray:(e,t,n,r,i,o,s)=>{execMany(e,r.map((e=>e instanceof SpreadArray?[...e.item]:[e])).flat(),t,s,o)},group:(e,t,n,r)=>t(void 0,r),string:(e,t,n,r,i,o)=>t(void 0,o.constants.strings[r]),regex:(e,t,n,r,i,o)=>{var s=o.constants.regexes[r];if(!o.ctx.globalsWhitelist.has(RegExp))throw new SandboxError("Regex not permitted");t(void 0,new RegExp(s.regex,s.flags))},literal:(e,t,n,r,i,o,s)=>{for(var a,c=o.constants.literals[r].a,p=[],l=[];a=literalRegex.exec(c);)a[2]||(p.push(o.constants.literals[r].b[parseInt(a[3],10)]),l.push(a[3]));execMany(e,p,((e,n)=>{var r={};if(e)t(e);else{for(var i in l){var o=l[i];r[o]=n[i]}t(void 0,c.replace(/(\\\\)*(\\)?\${(\d+)}/g,((e,t,n,i)=>{if(n)return e;var o=r[i];return o=o instanceof Prop?o.context[o.prop]:o,(t||"")+"".concat(o)})))}}),s,o)},spreadArray:(e,t,n,r,i,o,s)=>{e(r,s,o,((e,n)=>{e?t(e):t(void 0,new SpreadArray(n))}))},spreadObject:(e,t,n,r,i,o,s)=>{e(r,s,o,((e,n)=>{e?t(e):t(void 0,new SpreadObject(n))}))},"!":(e,t,n,r)=>t(void 0,!r),"~":(e,t,n,r)=>t(void 0,~r),"++$":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,++i.context[i.prop])},"$++":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]++)},"--$":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,--i.context[i.prop])},"$--":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]--)},"=":(e,t,n,r,i,o)=>{assignCheck(i,o),i.context[i.prop]=r,t(void 0,new Prop(i.context,i.prop,!1,i.isGlobal))},"+=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]+=r)},"-=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]-=r)},"/=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]/=r)},"*=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]*=r)},"**=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]**=r)},"%=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]%=r)},"^=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]^=r)},"&=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]&=r)},"|=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]|=r)},"<<=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]<<=r)},">>=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]>>=r)},">>>=":(e,t,n,r,i,o)=>{assignCheck(i,o),t(void 0,i.context[i.prop]>>=r)},"?":(e,t,n,r)=>{if(!(r instanceof If))throw new SyntaxError("Invalid inline if");t(void 0,n?r.t:r.f)},">":(e,t,n,r)=>t(void 0,n>r),"<":(e,t,n,r)=>t(void 0,n<r),">=":(e,t,n,r)=>t(void 0,n>=r),"<=":(e,t,n,r)=>t(void 0,n<=r),"==":(e,t,n,r)=>t(void 0,n==r),"===":(e,t,n,r)=>t(void 0,n===r),"!=":(e,t,n,r)=>t(void 0,n!=r),"!==":(e,t,n,r)=>t(void 0,n!==r),"&&":(e,t,n,r)=>t(void 0,n&&r),"||":(e,t,n,r)=>t(void 0,n||r),"&":(e,t,n,r)=>t(void 0,n&r),"|":(e,t,n,r)=>t(void 0,n|r),":":(e,t,n,r)=>t(void 0,new If(n,r)),"+":(e,t,n,r)=>t(void 0,n+r),"-":(e,t,n,r)=>t(void 0,n-r),"$+":(e,t,n,r)=>t(void 0,+r),"$-":(e,t,n,r)=>t(void 0,-r),"/":(e,t,n,r)=>t(void 0,n/r),"^":(e,t,n,r)=>t(void 0,n^r),"*":(e,t,n,r)=>t(void 0,n*r),"%":(e,t,n,r)=>t(void 0,n%r),"<<":(e,t,n,r)=>t(void 0,n<<r),">>":(e,t,n,r)=>t(void 0,n>>r),">>>":(e,t,n,r)=>t(void 0,n>>>r),typeof:(e,t,n,r)=>t(void 0,typeof r),instanceof:(e,t,n,r)=>t(void 0,n instanceof r),in:(e,t,n,r)=>t(void 0,n in r),delete:(e,t,n,r,i,o,s,a)=>{void 0!==a.context?(assignCheck(a,o,"delete"),a.isVariable?t(void 0,!1):t(void 0,delete a.context[a.prop])):t(void 0,!0)},return:(e,t,n,r,i,o)=>t(void 0,r),var:(e,t,n,r,i,o,s,a)=>{e(r,s,o,((e,r)=>{e?t(e):t(void 0,s.declare(n,VarType.var,r))}))},let:(e,t,n,r,i,o,s,a)=>{e(r,s,o,((e,r)=>{e?t(e):t(void 0,s.declare(n,VarType.let,r,a&&a.isGlobal))}))},const:(e,t,n,r,i,o,s,a)=>{e(r,s,o,((e,r)=>{e?t(e):t(void 0,s.declare(n,VarType.const,r))}))},arrowFunc:(e,t,n,r,i,o,s)=>{n.shift()?t(void 0,createFunctionAsync(n,r,o,s)):t(void 0,createFunction(n,r,o,s))},function:(e,t,n,r,i,o,s)=>{var a,c=n.shift(),p=n.shift();a=c?createFunctionAsync(n,r,o,s,p):createFunction(n,r,o,s,p),p&&s.declare(p,VarType.var,a),t(void 0,a)},inlineFunction:(e,t,n,r,i,o,s)=>{var a,c=n.shift(),p=n.shift();p&&(s=new Scope(s,{})),a=c?createFunctionAsync(n,r,o,s,p):createFunction(n,r,o,s,p),p&&s.declare(p,VarType.let,a),t(void 0,a)},loop:(e,t,n,r,i,o,s)=>{var[a,c,p,l,f,u]=n,d=!0,h=new Scope(s,{}),y=new Scope(h,{});if(e===execAsync)_asyncToGenerator((function*(){yield asyncDone((t=>e(p,h,o,t))),yield asyncDone((t=>e(c,y,o,t))),a&&(d=(yield asyncDone((t=>e(f,y,o,t)))).result);for(var n=function*(){var n={};yield asyncDone((t=>e(u,new Scope(y,n),o,t)));var i=yield executeTreeAsync(o,r,[new Scope(h,n)],"loop");return i instanceof ExecReturn&&i.returned?(t(void 0,i),{v:void 0}):i instanceof ExecReturn&&i.breakLoop?"break":(yield asyncDone((t=>e(l,y,o,t))),void(d=(yield asyncDone((t=>e(f,y,o,t)))).result))};d;){var i=yield*n();if("break"===i)break;if("object"==typeof i)return i.v}t()}))().catch(t);else{syncDone((t=>e(p,h,o,t))),syncDone((t=>e(c,y,o,t))),a&&(d=syncDone((t=>e(f,y,o,t))).result);for(var g=function(){var n={};syncDone((t=>e(u,new Scope(y,n),o,t)));var i=executeTree(o,r,[new Scope(h,n)],"loop");return i instanceof ExecReturn&&i.returned?(t(void 0,i),{v:void 0}):i instanceof ExecReturn&&i.breakLoop?"break":(syncDone((t=>e(l,y,o,t))),void(d=syncDone((t=>e(f,y,o,t))).result))};d;){var v=g();if("break"===v)break;if("object"==typeof v)return v.v}t()}},loopAction:(e,t,n,r,i,o,s)=>{if("switch"===o.inLoopOrSwitch&&"continue"===n||!o.inLoopOrSwitch)throw new SandboxError("Illegal "+n+" statement");t(void 0,new ExecReturn(o.ctx.auditReport,void 0,!1,"break"===n,"continue"===n))},if:(e,t,n,r,i,o,s)=>{if(!(r instanceof If))throw new SyntaxError("Invalid if");e(n,s,o,((n,i)=>{n?t(n):executeTreeWithDone(e,t,o,i?r.t:r.f,[new Scope(s)],o.inLoopOrSwitch)}))},switch:(e,t,n,r,i,o,s)=>{e(n,s,o,((n,i)=>{if(n)t(n);else if(e===execSync){var a,c=!1,p=function(n){if(c||(c=!n.a||i===valueOrProp(syncDone((t=>e(n.a,s,o,t))).result))){if(!n.b)return"continue";if((a=executeTree(o,n.b,[s],"switch")).breakLoop)return"break";if(a.returned)return t(void 0,a),{v:void 0};if(!n.a)return"break"}};for(var l of r){var f=p(l);if("continue"!==f){if("break"===f)break;if("object"==typeof f)return f.v}}t()}else _asyncToGenerator((function*(){var n,a=!1,c=function*(r){if(a||(a=!r.a||i===valueOrProp((yield asyncDone((t=>e(r.a,s,o,t)))).result))){if(!r.b)return"continue";if((n=yield executeTreeAsync(o,r.b,[s],"switch")).breakLoop)return"break";if(n.returned)return t(void 0,n),{v:void 0};if(!r.a)return"break"}};for(var p of r){var l=yield*c(p);if("continue"!==l){if("break"===l)break;if("object"==typeof l)return l.v}}t()}))().catch(t)}))},try:(e,t,n,r,i,o,s)=>{var[a,c,p]=r;executeTreeWithDone(e,((n,r)=>{executeTreeWithDone(e,(i=>{if(i)t(i);else if(n){executeTreeWithDone(e,t,o,c,[new Scope(s)],o.inLoopOrSwitch)}else t(void 0,r)}),o,p,[new Scope(s,{})])}),o,n,[new Scope(s)],o.inLoopOrSwitch)},void:(e,t,n)=>{t()},new:(e,t,n,r,i,o)=>{if(!o.ctx.globalsWhitelist.has(n)&&!sandboxedFunctions.has(n))throw new SandboxError("Object construction not allowed: ".concat(n.constructor.name));t(void 0,new n(...r))},throw:(e,t,n)=>{t(n)},multi:(e,t,n,r,i,o,s)=>t(void 0,n.pop())},ops=new Map;for(var op in ops2)ops.set(op,ops2[op]);function valueOrProp(e){return e instanceof Prop?e.context[e.prop]:e}function execMany(e,t,n,r,i){var o=[],s=0;if(t.length){var a=(c,p)=>{c?n(c):(o.push(p),++s<t.length?e(t[s],r,i,a):n(void 0,o))};e(t[s],r,i,a)}else n(void 0,[])}function asyncDone(e){return new Promise(((t,n)=>{e(((e,r)=>{e?n(e):t({result:r})}))}))}function syncDone(e){var t,n;if(e(((e,r)=>{n=e,t=r})),n)throw n;return{result:t}}function execAsync(e,t,n,r){return _execAsync.apply(this,arguments)}function _execAsync(){return(_execAsync=_asyncToGenerator((function*(e,t,n,r){var i;try{if(e instanceof Prop)i=e.context[e.prop];else if(Array.isArray(e)){var o=[],s=function*(e){var r=(yield asyncDone((r=>execAsync(e,t,n,r)))).result;if(r instanceof ExecReturn){if(o.push(r.result),r.returned||r.breakLoop||r.continueLoop)return o=r,"break"}else o.push(r)};for(var a of e){if("break"===(yield*s(a)))break}i=o}else if(e instanceof Lisp)if(["arrowFunc","function","inlineFunction","loop","try","switch","if"].includes(e.op))i=(yield asyncDone((r=>ops.get(e.op)(execAsync,r,e.a,e.b,void 0,n,t)))).result;else if("await"===e.op)i=yield(yield asyncDone((r=>execAsync(e.a,t,n,r)))).result;else{var c=(yield asyncDone((r=>execAsync(e.a,t,n,r)))).result,p=c instanceof Prop?c.context?c.context[c.prop]:void 0:c,l=(yield asyncDone((r=>execAsync(e.b,t,n,r)))).result,f=l instanceof Prop?l.context?l.context[l.prop]:void 0:l;if(!ops.has(e.op))throw new SyntaxError("Unknown operator: "+e.op);i=(yield asyncDone((r=>ops.get(e.op)(execAsync,r,p,f,c,n,t,l)))).result}else i=e;r(void 0,i)}catch(e){r(e)}}))).apply(this,arguments)}function syncDoneExec(e,t,n){var r,i;if(execSync(e,t,n,((e,t)=>{i=e,r=t})),i)throw i;return{result:r}}function syncDoneOp(e,t,n,r,i,o,s){var a,c;if(ops.get(e)(execSync,((e,t)=>{c=e,a=t}),t,n,r,i,o,s),c)throw c;return{result:a}}function execSync(e,t,n,r){var i;if(e instanceof Prop)i=e.context[e.prop];else if(Array.isArray(e)){var o=[];for(var s of e){var a=syncDoneExec(s,t,n).result;if(a instanceof ExecReturn){if(o.push(a.result),a.returned||a.breakLoop||a.continueLoop){o=a;break}}else o.push(a)}i=o}else if(e instanceof Lisp)if(["arrowFunc","function","inlineFunction","loop","try","switch","if"].includes(e.op))i=syncDoneOp(e.op,e.a,e.b,void 0,n,t).result;else{if("await"===e.op)throw new SandboxError("Illegal use of 'await', must be inside async function");var c=syncDoneExec(e.a,t,n).result,p=c instanceof Prop?c.context?c.context[c.prop]:void 0:c,l=syncDoneExec(e.b,t,n).result,f=l instanceof Prop?l.context?l.context[l.prop]:void 0:l;if(!ops.has(e.op))throw new SyntaxError("Unknown operator: "+e.op);i=syncDoneOp(e.op,p,f,c,n,t,l).result}else i=e;r(void 0,i)}function executeTree(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3?arguments[3]:void 0;return syncDone((i=>executeTreeWithDone(execSync,i,e,t,n,r))).result}function executeTreeAsync(e,t){return _executeTreeAsync.apply(this,arguments)}function _executeTreeAsync(){return(_executeTreeAsync=_asyncToGenerator((function*(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],r=arguments.length>3?arguments[3]:void 0;return(yield asyncDone((i=>executeTreeWithDone(execAsync,i,e,t,n,r)))).result}))).apply(this,arguments)}function executeTreeWithDone(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=arguments.length>5?arguments[5]:void 0;if(r){if(!(r instanceof Array))throw new SyntaxError("Bad execution tree");for(var s,a=(n={ctx:n.ctx,constants:n.constants,inLoopOrSwitch:o}).ctx.globalScope;s=i.shift();)"object"==typeof s&&(a=s instanceof Scope?s:new Scope(a,s,null));n.ctx.options.audit&&!n.ctx.auditReport&&(n.ctx.auditReport={globalsAccess:new Set,prototypeAccess:{}});var c=0,p=r[c],l=(i,o)=>{if(i)t(new i.constructor(i.message));else if(o instanceof ExecReturn)t(void 0,o);else if(p instanceof Lisp&&"return"===p.op)t(void 0,new ExecReturn(n.ctx.auditReport,o,!0));else if(++c<r.length){p=r[c];try{e(p,a,n,l)}catch(e){t(e)}}else t(void 0,new ExecReturn(n.ctx.auditReport,void 0,!1))};try{e(p,a,n,l)}catch(e){t(e)}}else t()}class SandboxGlobal{constructor(e){if(e===globalThis)return globalThis;for(var t in e)this[t]=e[t]}}class Sandbox{constructor(){var globals=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Sandbox.SAFE_GLOBALS,prototypeWhitelist=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Sandbox.SAFE_PROTOTYPES,prototypeReplacements=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Map,options=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{audit:!1},sandboxGlobal=new SandboxGlobal(globals);this.context={sandbox:this,globals:globals,prototypeWhitelist:prototypeWhitelist,prototypeReplacements:prototypeReplacements,globalsWhitelist:new Set(Object.values(globals)),options:options,globalScope:new Scope(null,globals,sandboxGlobal),sandboxGlobal:sandboxGlobal,evals:new Map,getSubscriptions:new Set,setSubscriptions:new WeakMap,changeSubscriptions:new WeakMap};var func=sandboxFunction(this.context);this.context.evals.set(Function,func),this.context.evals.set(eval,sandboxedEval(func)),this.context.evals.set(setTimeout,sandboxedSetTimeout(func)),this.context.evals.set(setInterval,sandboxedSetInterval(func))}static get SAFE_GLOBALS(){return{Function:Function,console:{debug:console.debug,error:console.error,info:console.info,log:console.log,table:console.table,warn:console.warn},isFinite:isFinite,isNaN:isNaN,parseFloat:parseFloat,parseInt:parseInt,decodeURI:decodeURI,decodeURIComponent:decodeURIComponent,encodeURI:encodeURI,encodeURIComponent:encodeURIComponent,escape:escape,unescape:unescape,Boolean:Boolean,Number:Number,String:String,Object:Object,Array:Array,Symbol:Symbol,Error:Error,EvalError:EvalError,RangeError:RangeError,ReferenceError:ReferenceError,SyntaxError:SyntaxError,TypeError:TypeError,URIError:URIError,Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array,Map:Map,Set:Set,WeakMap:WeakMap,WeakSet:WeakSet,Promise:Promise,Intl:Intl,JSON:JSON,Math:Math,Date:Date}}static get SAFE_PROTOTYPES(){var e=[SandboxGlobal,Function,Boolean,Number,String,Date,Error,Array,Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,Map,Set,WeakMap,WeakSet,Promise,Symbol,Date],t=new Map;return e.forEach((e=>{t.set(e,new Set)})),t.set(Object,new Set(["entries","fromEntries","getOwnPropertyNames","is","keys","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf","values"])),t}subscribeGet(e){return this.context.getSubscriptions.add(e),{unsubscribe:()=>this.context.getSubscriptions.delete(e)}}subscribeSet(e,t,n){var r=this.context.setSubscriptions.get(e)||new Map;this.context.setSubscriptions.set(e,r);var i,o=r.get(t)||new Set;return r.set(t,o),o.add(n),e&&e[t]&&"object"==typeof e[t]&&((i=this.context.changeSubscriptions.get(e[t])||new Set).add(n),this.context.changeSubscriptions.set(e[t],i)),{unsubscribe:()=>{o.delete(n),i&&i.delete(n)}}}static audit(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return new Sandbox(globalThis,new Map,new Map,{audit:!0}).executeTree(parse(e),t)}static parse(e){return parse(e)}executeTree(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return executeTree({ctx:this.context,constants:e.constants},e.tree,t)}executeTreeAsync(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return executeTreeAsync({ctx:this.context,constants:e.constants},e.tree,t)}compile(e){var t=this,n=parse(e);return function(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t.executeTree(n,r).result}}compileAsync(e){var t=this,n=parse(e);return _asyncToGenerator((function*(){for(var e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return(yield t.executeTreeAsync(n,r)).result}))}}exports.SandboxGlobal=SandboxGlobal,exports.default=Sandbox;
//# sourceMappingURL=Sandbox.js.map
